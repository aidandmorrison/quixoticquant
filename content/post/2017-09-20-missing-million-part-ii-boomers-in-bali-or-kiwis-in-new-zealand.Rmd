---
title: 'Missing Million Part II: Boomers in Bali or Kiwis In New Zealand?'
author: Aidan Morrison
date: '2017-09-20'
slug: missing-million-part-ii-boomers-in-bali-or-kiwis-in-new-zealand
thumbnail: "images/IndoNZ3.png"
categories:
  - Demographics
  - Economics
  - Migration
tags:
  - Ausecon
  - Census
  - Immigration
  - Statistics
  - ABS
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r get_data, include=FALSE, warning=FALSE, message= FALSE}
library(tidyverse)
library(stringr)
library(gdata)
library(lubridate)
library(plotly)
library(UtilsQQ)
library(ggplot2)
library(nnls)


sheet_310101 <- readxl::read_xls("data/310101.xls", sheet = 2)
sheet_310101 <- good_names(sheet = sheet_310101)
meta <- stash_meta(sheet_310101)
meta <- good_names(meta, meta = TRUE)
sheet_310101 <- cut_meta(sheet_310101)
sheet_310101 <- good_date(sheet_310101)
sheet_310101 <- to_numeric(sheet_310101)
sheet_310101 <- nom_units(sheet_310101, meta)
sheet_310101 <- inst_ann(sheet_310101, meta)
sheet_310101 <- prev_12_month(sheet_310101, meta)

sheet_340101 <- readxl::read_xls("data/340101.xls", sheet = 2)

sheet_340101 <- good_names(sheet = sheet_340101)
meta1 <- stash_meta(sheet_340101)
meta1 <- good_names(meta1, meta = TRUE)
meta <- bind_rows(meta, meta1)
sheet_340101 <- cut_meta(sheet_340101)
sheet_340101 <- good_date(sheet_340101)
sheet_340101 <- to_numeric(sheet_340101)
sheet_340101 <- nom_units(sheet_340101, meta)
sheet_340101 <- inst_ann(sheet_340101, meta)
sheet_340101 <- prev_12_month(sheet_340101, meta)

sheet_340102 <- readxl::read_xls("data/340102.xls", sheet = 2)

sheet_340102 <- good_names(sheet = sheet_340102)
meta2 <- stash_meta(sheet_340102)
meta2 <- good_names(meta2, meta = TRUE)
meta <- bind_rows(meta, meta2)
sheet_340102 <- cut_meta(sheet_340102)
sheet_340102 <- good_date(sheet_340102)
sheet_340102 <- to_numeric(sheet_340102)
sheet_340102 <- nom_units(sheet_340102, meta)
sheet_340102 <- inst_ann(sheet_340102, meta)
sheet_340102 <- prev_12_month(sheet_340102, meta)


sheet_310101 <- sheet_310101 %>% 
  mutate(NOM.12.12.Pre.12 = (case_when(Date < "2006-09-01 GMT" ~ Net.Ove.Mig.Aus.Pre.12m)),
         NOM.12.16.Pre.12 = (case_when(Date >= "2006-09-01 GMT" ~ Net.Ove.Mig.Aus.Pre.12m)))

sheet_arr_dep <- bind_cols(sheet_340101, sheet_340102)
sheet_arr_dep <- sheet_arr_dep %>% 
  mutate(net.movements = (Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep),
         net.per.long.term = (Num.of.mov.Per.and.Lon.ter.Arr - Num.of.mov.Per.and.Lon.ter.Dep),
         net.movements.Pre.12m = (Num.of.mov.Tot.Arr.Pre.12m - Num.of.mov.Tot.Dep.Pre.12m)
  )

match_sheet_arr_dep <- sheet_arr_dep %>% 
  filter(Date %in% sheet_310101$Date)

joint_sheet_310101 <- sheet_310101 %>% 
  inner_join(match_sheet_arr_dep, by = "Date")

joint_sheet_310101 <- joint_sheet_310101 %>% 
  mutate(Net.Ove.Mig.Aus.Pre.12m.per.ERP = (Net.Ove.Mig.Aus.Pre.12m/Est.Res.Pop.ERP.Aus),
         net.movements.Pre.12m.per.ERP = (net.movements.Pre.12m/Est.Res.Pop.ERP.Aus),
         cum.net.movements = cumsum(net.movements.Pre.12m/4),
         cum.Net.Ove.Mig.Aus = cumsum(Net.Ove.Mig.Aus),
         cum.discrepancy = cum.Net.Ove.Mig.Aus - cum.net.movements,
         Phy.Pre.Pop.PPP.Aus = Est.Res.Pop.ERP.Aus - cum.discrepancy,
         Net.Ove.Mig.Aus.Pre.12m.per.PPP = Net.Ove.Mig.Aus.Pre.12m/Phy.Pre.Pop.PPP.Aus,
         net.movements.Pre.12m.per.PPP = net.movements.Pre.12m/Phy.Pre.Pop.PPP.Aus
  )

datevec <- sheet_340101 %>% 
  filter(Date < "2006-09-01 GMT")%>% 
  select(Date)

date_change <- length(datevec$Date) +1

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="defining 12 month function"}
  month_mutate <- function(sheet, expr) {
    expr <- rlang::parse_quosure(expr)
    pre_12_name <- paste0( quo_name(expr), ".Pre.12m")

    mutate(sheet,
           static.var = !!expr,
           !!pre_12_name := (static.var + lag(static.var, n = 1) + lag(static.var, n = 2) + lag(static.var, n = 3) +
                               lag(static.var, n = 4) + lag(static.var, n = 5) + lag(static.var, n = 6) +
                               lag(static.var, n = 7) + lag(static.var, n = 8) + lag(static.var, n = 9) +
                               lag(static.var, n = 10) + lag(static.var, n = 11) )
    )
  }
```

This post is a follow-on to [Dr. Cameron Murray's](http://www.fresheconomicthinking.com/2017/09/finding-australias-missing-million.html) reply to my [first post](http://www.quixoticquant.com/post/the-missing-million/) on migration. In my first post I published the following graph demonstrating that Australia's population included a 'missing million' people who we counted as resident, but who were actually overseas at any given time.

```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The cumulative discrepancy between official NOM and the population actually in Australia has exploded"}

plot <-ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_col(aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6)+
  geom_line(aes(y = NOM.12.12.Pre.12, col = "NOM 12/12 Definition"), size = .8)+
  geom_line(aes(y = NOM.12.16.Pre.12, col = "NOM 12/16 Definition"), size = .8)+
  geom_line(aes(x = Date, y = net.movements.Pre.12m, colour = "Net Overseas Movements"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("Cumulative Discrepancy", "Net Overseas Migration", "Net Overseas Movements"),
                      values = c("grey30", "blue", "red", "magenta1" ))+
  labs(title = "Net Overseas Migration vs Net Movements, and Cumulative Discrepancy")+
  geom_vline(xintercept = as.numeric(sheet_340101$Date[date_change]), linetype = 4, size = 0.4) +
  scale_y_continuous("Number")+
  geom_text(x = as.numeric(sheet_340101$Date[date_change - 40]), y = 750000, label =  "Break in 
            Methodology", size =3)+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```

Cameron's response was to investigate some further data from ABS 3401 to see if he could determine roughly where these people were, and what sort of travel they were engaged in.  He produced four graphs which lead him to conclude that the Missing Million were quite probably substantially composed of newly retired Baby-Boomers and their families, who were likely to be on short holiday visits to places like Bali in Indonesia.  

The investigation and further research is useful and welcome, as it at least attempts to engage with some of the complexity surrounding migration measurement, which I've [lamented](https://www.quixoticquant.com/post/the-state-of-debate-a-bird-s-eye-on-migration/) is universally glossed-over.  I've also [lamented](https://www.quixoticquant.com/post/the-state-of-debate-a-bird-s-eye-on-migration/) after the guys from [Macrobusiness](https://www.macrobusiness.com.au/2017/09/apparently-no-immigration-boom/) seized on Cameron's response as a 'rebuke', how even this narrative exposes how the details of migration could lead to completely counter-productive knee-jerk reactions, which Macrobusiness seems inclined to make.  A million boomers who will come back from holiday to get sick and die in Australia will lead to a completely different policy response to a million young 'migrants' getting jobs and starting families here who spend a chunk of the year back in their other 'home'. Kicking out the latter will do nothing to help ease the pressures created by the former.

However, the four graphs that Cameron has produced provide a great example of the dangers of drawing quick conclusions from data.  He seizes on a narrative which relies on committing the oldest data-interpretation error in the book (confusing correlation with causation) four times over in quick succession, when a few simple techniques (like eye-balling the raw relevant data, or doing a back-of-the-envelope calculation to check orders of magnitude) show that the evidence doesn't stack up, and possibly points elsewhere.

## Why we need to talk about Kiwis
The alternative narrative that I'll champion here, is that a larger share of the Missing Million is actually Kiwis, probably relatively young ones, who have come to Australia to work or study, but spend rather significant amount of time (in various trip-lengths) back in New Zealand.  I won't try to prove that it's the dominant component, since there isn't clear evidence for that either, in fact it appears that the Missing Million must comprise quite a variety of traveller types.  But it fits the data better than the Boomers in Bali story since departures to New Zealand are the dominant component of short-term departures, so it's a reasonable angle to take to refute my 'rebuke'.

It's also a fun narrative to choose because it contrasts so well in every sense with the Cameron's hypothesis in a policy sense.  Unlike Aussie Boomers returning from their retirement holidays, it's quite possible that the New Zealanders will actually make a general exodus at some point, and decide that New Zealand is at least as good a place to live in their next life stage, such as raising a family or retiring.  It's also possible that they might continue to use a significant number of services (like health-care) in New Zealand on their trips back home.  

Perhaps best of all, the case of the Kiwis highlights the misnomer that 'Net Overseas Migration' being closely linked to "Permanent Migration Program", which small-Australia advocates like Macrobusiness continually urge the Federal Government to reduce.  Unless we want to tear up our reciprocal arrangement with our New Zealand brothers over the ditch, this significant component of migration isn't something that cutting the permanent migration program will have even the slightest impact on.  Kiwis don't need a permanent visa to live here permanently, and neither do we in New Zealand.

As we can see here from the [Department of Immigration and Border Protection](https://www.border.gov.au/ReportsandPublications/Documents/statistics/temp-entrants-aus-31-dec-2016.pdf), there are more New Zealanders in Australia than any other type of temporary entrant.  Well over 600,000.  

```{r, fig.align="center", out.width = 500, fig.cap="New Zealanders make up the largest share of 'Temporary Entrants' in Australia"}


knitr::include_graphics("images/TempEnt.png")

```

However New Zealanders have reciprocal arrangements with Australia that allows them to remain 'temporary' permanently, and do all the things that we normally associate with permanent residents, like working, and coming and going as they please.  As a result, they actually constitute a surprising slab of the [official "Net Overseas Migration"](http://www.border.gov.au/ReportsandPublications/Documents/statistics/migration-trends-14-15-full.pdf) intake.  In fact, since 2008 when Australia's supposedly turbo-charged migration intake really started, New Zealanders have contributed just as much as almost any other category except students. 

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NOM Breakdown"}

sheet_NOM <- readxl::read_xls("data/NOM_by_visa.xls", sheet = 1)
sheet_NOM <- t(sheet_NOM) %>%  
  as_tibble()
#sheet_NOM <-data.frame(sheet_NOM) %>% as_tibble()
rownames(sheet_NOM) <- NULL
sheet_NOM <- sheet_NOM[-1,]

dates <- c("2007-06-30", "2008-06-30", "2009-06-30", "2010-06-30",
           "2011-06-30", "2012-06-30", "2013-06-30", "2014-06-30",
           "2015-06-30") %>% ymd() %>% as.numeric()

dates_vec <- tibble(dates)

sheet_NOM <- bind_cols(sheet_NOM, dates_vec)
sheet_NOM <- select(sheet_NOM, dates, everything())
colnames(sheet_NOM) <- c("Date", "Student", "Subclass 457", "Working Holiday", "Visitor", 
                         "Other Temp.", "Skilled", "Family", "Humanitarian",
                         "Other Perm.", "Aus Citizen", "NZ Citizen", "Other Visas")

sheet_NOM <- sheet_NOM %>% 
  good_names() %>% 
  good_date(Origin = "1970-01-01") %>% 
  to_numeric() %>% 
  nom_units(meta = meta, manual = "000")

sheet_NOM <- sheet_NOM %>% 
  mutate(Tot.Temp = (Stu + Sub.457 + Wor.Hol + Vis + Oth.Tem),
         Tot.Perm = (Ski + Fam + Hum + Oth.Per),
         Tot.Oth = (Aus.Cit + NZ.Cit + Oth.Vis))

sheet_NOM_long <- sheet_NOM %>% 
  gather(key = "Visa.cat", value = "flow", -Date)

sheet_NOM_long <- sheet_NOM_long %>% 
  mutate(Type = case_when(Visa.cat %in% c("Stu", "Sub.457", "Wor.Hol", "Vis","Oth.Tem") ~ "Temporary",
                          Visa.cat %in% c("Ski", "Fam", "Hum", "Oth.Per") ~ "Permanent",
                          Visa.cat %in% c("Aus.Cit", "NZ.Cit", "Oth.Vis") ~ "Other",
                          Visa.cat %in% c("Tot.Temp", "Tot.Perm", "Tot.Oth") ~ "Totals"))
    
    
    
pre_plot <- sheet_NOM_long %>% 
  filter(str_detect(Visa.cat, "Tot.") == FALSE) %>% 
  arrange(Type)

lvls <- unique(pre_plot$Visa.cat)


 plot<- pre_plot %>% 
    mutate(Visa.cat = factor(Visa.cat, levels = lvls)) %>% 
   ggplot(aes(x = Date, text = as_date(Date), y = flow, fill = Visa.cat, colour = Type))+
    geom_bar(position = "stack", stat = "identity")+
   scale_colour_manual("",
                      breaks = c("Temporary", "Permanent", "Other"),
                      values = c("grey", "black", "white"))+
    theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  labs(title = "Net Overseas Migration by Visa")+
   scale_y_continuous(labels = scales::comma)


ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 70, b = 60, r = 70))

```

I can't help but make further passing observation here, that all the permanent visa categories (in black boxes) during this period rarely add up much past 70,000, which is about the number that most of the small-Australia advocates advocate anyway.  It's the influx of temporary entrants that has really driven the appearance of extremely high migration during this period, which is consistent with the broad thesis I outlined in a [previous post](https://www.quixoticquant.com/post/the-state-of-debate-a-bird-s-eye-on-migration/) about 'mobility' rather than 'migration' having made a level-shift.  Eliminating the entire "Permanent Migration Program" from 190,000 to zero won't do anything to reduce two thirds of the migration we actually have.  In fact it would probably just drive a further increase in temporary entrants, including on Bridging visas, but I'll focus on that charge another day.

## The Boomers in Bali Narrative
The image Cameron Murray created of the Missing Million relied on four characteristics in short-term departures: reason for departure (holiday), length of stay (short), destination (Indonesia), and age (older).

Sure enough, he has a chart which says the highest level of growth comes from growth in holidays:

```{r, fig.align="center", out.width = 500, fig.cap="Holiday travel seems to have risen the fastest"}


knitr::include_graphics("images/STreason.png")

```

And of course, there's a graph which says that the fastest growth is in short-term trips as well.

```{r, fig.align="center", out.width = 500, fig.cap="Very short travel seems to have risen the fastest"}


knitr::include_graphics("images/STlength.png")

```

And departures to Indonesia also seem to have risen the most sharply from the mid 2000s as well:

```{r, fig.align="center", out.width = 500, fig.cap="Indonesia rose very quickly as a destination"}


knitr::include_graphics("images/STdestination.png")

```

And there's a hint as well that somewhat older people might make up a higher fraction of travellers of lately too.

```{r, fig.align="center", out.width = 500, fig.cap="Older people are travelling more in relative terms"}


knitr::include_graphics("images/agetravel.png")

```

So it would be very tempting to conclude that the same set of travellers are driving the relevant trends in all of those cases, and that those travellers also constitute a significant share of the "Missing Million".  To do so would be to essentially make a whole sweeping set of assumptions which haven't even been discussed, let alone tested, and some can be demonstrated to be substantially untrue.

Perhaps the easiest to tackle is the last graph, whch was used to suggest that a significant number of travelers might be the old boomers.  The problem with this graph is that it's expressed as a percentage.  As I've [previously outlined](https://www.quixoticquant.com/post/movement-trends-speed-and-seasonality/), the most striking trend in overseas travel is that it's increased, quickly and relentlessly.  If the two curves shown in Figure 7 referred to numbers of movements, the 2015-16 lines would be consistently far higher (about one and a half times) as the 2005-2006 lines.  Whilst a somewhat higher share recently are 60-something than previously, movements are now so high in all other categories that change that caused the discrepancy could be in any other age-group just as easily.

With regards to the other data, first and favourite technique to test a hypothesis is to just have a look at relevant data with the Mk 1 eyeball.  Adding in the cumulative discrepancy between NOM and Net Movements, we can see how and when the Missing Million actually grows:

```{r get_data3, include=FALSE, warning=FALSE, message= FALSE}

sheet_3401010 <- readxl::read_xls("data/3401010.xls", sheet = 2)

sheet_3401010 <- good_names(sheet = sheet_3401010)
meta4 <- stash_meta(sheet_3401010)
meta4 <- good_names(meta4, meta = TRUE)
meta <- bind_rows(meta, meta4)
sheet_3401010 <- cut_meta(sheet_3401010)
sheet_3401010 <- good_date(sheet_3401010)
sheet_3401010 <- to_numeric(sheet_3401010)
sheet_3401010 <- nom_units(sheet_3401010, meta)
sheet_3401010 <- inst_ann(sheet_3401010, meta4)
sheet_3401010 <- prev_12_month(sheet_3401010, meta4)

```


```{r get_data2, include=FALSE, warning=FALSE, message= FALSE}
sheet_340106 <- readxl::read_xls("data/340106.xls", sheet = 2)

sheet_340106 <- good_names(sheet = sheet_340106)
meta3 <- stash_meta(sheet_340106)
meta3 <- good_names(meta3, meta = TRUE)
meta <- bind_rows(meta, meta3)
sheet_340106 <- cut_meta(sheet_340106)
sheet_340106 <- good_date(sheet_340106)
sheet_340106 <- to_numeric(sheet_340106)
sheet_340106 <- nom_units(sheet_340106, meta)
sheet_340106 <- inst_ann(sheet_340106, meta)
sheet_340106 <- prev_12_month(sheet_340106, meta)


```

```{r get_data4, include=FALSE, warning=FALSE, message= FALSE}

sheet_340109 <- readxl::read_xls("data/340109.xls", sheet = 2)

sheet_340109 <- good_names(sheet = sheet_340109, trunc_length = 4)
meta5 <- stash_meta(sheet_340109)
meta5 <- good_names(meta5, meta = TRUE, trunc_length = 4)
meta <- bind_rows(meta, meta5)
sheet_340109 <- cut_meta(sheet_340109)
sheet_340109 <- good_date(sheet_340109)
sheet_340109 <- to_numeric(sheet_340109)
sheet_340109 <- nom_units(sheet_340109, meta5)
sheet_340109 <- inst_ann(sheet_340109, meta5)
sheet_340109 <- prev_12_month(sheet_340109, meta5)

topcountries <- sheet_340109 %>% 
  filter(Date > "2014-01-01 GMT") %>% 
  select(Numb.of.move.Norf.Isla:Numb.of.move.Tota.Coun.of.stay) %>% 
  gather(country, movements, Numb.of.move.Norf.Isla:Numb.of.move.Tota.Coun.of.stay)
  
topcountriessum <- topcountries %>% 
  group_by(country) %>% 
  summarise(ave_mov = mean(movements)) %>% 
  arrange(ave_mov, desc(ave_mov)) %>% 
  filter(str_detect(country, ".Tota.") == FALSE) %>% 
  tail(n = 15)

topregionssum <- topcountries %>% 
  group_by(country) %>% 
  summarise(ave_mov = mean(movements)) %>% 
  arrange(ave_mov, desc(ave_mov)) %>% 
  filter(str_detect(country, ".Tota.") == TRUE) %>% 
  tail(n = 10)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="The cumulative missing million doesn't match "}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_col(data = joint_sheet_310101 %>% filter(Date > "1991-12-01 GMT"), aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6, colour = "grey")+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m, col = "6 to 12 months"))+
  labs(title = "Short Term Resident Departures Previous 12 Months, and Missing Million")+
  scale_y_continuous(labels = scales::comma, limits = c(0, 3200000)) +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))

```

As we can clearly see there, the discrepancy between NOM and Net Movements seemed to have really become serious in the very early 2000s, quite possibly before the marked acceleration in Short-Term Departures. It does however appear that Short-Term Departures do seem to track somewhat with the cumulative discrepancy thereafter.  However, the same isn't the case with Departures by destination:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Travel to Indonesia was low while most of the Missing Million left."}

plot <- sheet_340109 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_col(data = joint_sheet_310101 %>% filter(Date > "1991-12-01 GMT"), aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6, col = "grey")+
  geom_line(aes(y = Numb.of.move.New.Zeal.Pre.12m, col = "NZ"))+
  geom_line(aes(y = Numb.of.move.Indo.Pre.12m, col = "Indonesia"))+
  geom_line(aes(y = Numb.of.move.Unit.Stat.of.Amer.Pre.12m, col = "USA"))+
  geom_line(aes(y = Numb.of.move.UK.CIs.IOM.Pre.12m, col = "UK"))+
  geom_line(aes(y = Numb.of.move.Thai.Pre.12m, col = "Thailand"))+
  geom_line(aes(y = Numb.of.move.Chin.Pre.12m, col = "China"))+
  geom_line(aes(y = Numb.of.move.Sing.Pre.12m, col = "Singapore"))+
  geom_line(aes(y = Numb.of.move.Fiji.Pre.12m, col = "Fiji"))+
  geom_line(aes(y = Numb.of.move.Japa.Pre.12m, col = "Japan"))+
  labs(title = "Short Term Monthly Departures Prev. 12 Months by Destination")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))


```

Here it can be see that the accumulation of the first half of the Missing Million occurred while travel to Indonesia was actually low, and not growing.  Furthermore, at precisely the time of the fastest acceleration in travel to Indonesia, NOM and Net Movements came closest to aligning. In contrast, travel to New Zealand grew consistently throughout this period, not to mention being higher throughout.  I'd argue that NZ looks more likely by far at this stage.

My second favourite technique is to do just to a quick of some numbers, to see whether things add-up even roughly, at least to within an order-of-magnitude.  Looking at the Short-Term-Departures by duration, we can multiply each series by an appropriate number to see what sort of impact each component might actually have on people actually absent from Australia. Not having any better information, I assumed that the distribution of movement lengths in each category was reasonably flat, and chose 4, 11, 22, 46, 77, 165, and 273 as the probable average number of person-days that each departure would reduce from Australia's Physically Present Population.  I then took the previous 12 month calculation and divided by 365 to find the total number of 'person-years' that each set of departures could contribute at any given point, to see which contributed the most. 

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Departures of longer than one month have the largest contribution to persons absent"}
# Impact of Departures by Time
plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m*22/365, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m*11/365, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m*4/365, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m*46/365, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m*77/365, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m*165/365, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m*273/365, col = "6 to 12 months"))+
  labs(title = "Person-Year absent from Short Term Departures")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))

days.vec <- c(4/365, 11/365, 22/365, 46/365, 77/365, 165/365, 273/365)
days.tab <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee.Pre.12m" ,  "Num.of.mov.1.and.und.2.wee.Pre.12m", "Num.of.mov.2.wee.and.und.1.mon.Pre.12m",
"Num.of.mov.1.and.und.2.mon.Pre.12m", "Num.of.mov.2.and.und.3.mon.Pre.12m", "Num.of.mov.3.and.und.6.mon.Pre.12m", "Num.of.mov.6.and.und.12.mon.Pre.12m")) %>% 
  select(Component, days.vec) %>% 
  mutate(monthly.vec = days.vec*12)

end.vec <- sheet_3401010 %>% 
  select(Num.of.mov.Und.1.wee.Pre.12m:Num.of.mov.6.and.und.12.mon.Pre.12m) %>% 
  tail(n = 1) %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column(var = c("Component"))
colnames(end.vec) <- c("Component", "Movement.end")

mid.vec <- sheet_3401010 %>% 
  filter(Date > "2001-12-30 GMT") %>% 
  filter(Date < "2002-01-31 GMT") %>% 
  select(Num.of.mov.Und.1.wee.Pre.12m:Num.of.mov.6.and.und.12.mon.Pre.12m) %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column(var = c("Component"))
colnames(mid.vec) <- c("Component", "Movement.mid")

days.tab <- days.tab %>% 
  inner_join(end.vec, by = "Component") %>% 
  inner_join(mid.vec, by = "Component")

days.tab <- days.tab %>% 
  mutate(mid.absent = Movement.mid*days.vec, end.absent = Movement.end*days.vec)

absent.shift <- days.tab %>% 
  summarise(absent2001 = sum(mid.absent), absent2017 = sum(end.absent))
```

We can see here that the impact of trips less than two weeks is very greatly diminished.  The largest contributor to the Missing Million is likely to be trips of over a month, hardly a fleeting holiday.

But more interestingly, we can see that the short-term departures of all the trips under two months clearly can't add up to anything like a million people.  I did some calculations and found that in fact at the end of the data all the short-term departures probably only cumulatively add up to under 800,000.  I suspect the assumption of a flat distribution across all the categories is likely to overstate absence if anything.  Furthermore, at the end of 2001, before the Missing Million had left, those departures accounted for about 400,000 people absent.  So it really isn't plausible that all these departures listed actually account for anything like the full Missing Million, or probably even half of that.  The sub-set of Boomers that Cameron Murray describes is doomed to be a trivial minority in any case.  

There's also the possibility of significant a shift internally within categories.  It could be the case that my estimation of a flat distribution across each time interval is false, and some change has led quite systematically to some of the categories to become increasingly skewed, probably to the left (shorter trips) since the frequency of travel has risen so much.  The switching over of the 6-12 month and 3-6 month lines seems to show some evidence of that occurring, however if a shift in that direction also occurs internally within the categories, we would likely have even less of the Missing Million accounted for. 

## A reality-check on Data Quality
There are a few things that could explain such a result, and as always it's probably best to go back to the source of the data to try to understand why it is possible.  A significant factor is that the data presented here is based on peoples indicated intent, as per their passenger departure cards, like this one:  

```{r, fig.align="center", out.width = 600, fig.cap="The departure card assumed that people know whether they are 'resident' or 'termporary entrant'."}


knitr::include_graphics("images/ddcard3.jpg")

```

The largest failure in these cards is asking people to self-select what type of traveller they are, most confusingly whether they are a 'visitor or temporary entrant' or 'Australian resident'.  Since these cards don't come with any explanation of the 12/16 rule of 'residence' for migration purposes, these cards would make no sense for our increasingly part-time population, many of whom are foreign citizens, here on a temporary visa, but staying (as a Student, worker, or backpacker) for long enough to officially qualify to be 'resident' for migration purposes.  So the entire data-series we're working with here really is likely to be fraught with uncertainty, and doesn't promise to consistently include those who should be counted, or exclude those who should not be.

Furthermore, there's absolutely no obligation on the traveller to honour their 'intent' regarding travel.  Often they may not have actually booked their onward or return flight.  If I had to speculate a little as to the micro-economic dynamics that might be at work, I would think that plenty of travellers (particularly those on temporary visas in Australia) would wind up indicating something that was a poor reflection of what actually happens. With more and more people making multiple stops on their travels, with fewer of them planned in advance, they're likely to make some educated guess about what the scary people at the customs gate are going to be most happy to hear, (including about their residency status) and just report that.

To add to this, not all the data captured in departure cards is comprehensively enumerated.  According to the ABS, on average, [only about 5%](http://www.abs.gov.au/AUSSTATS/abs@.nsf/Lookup/3401.0Explanatory%20Notes1Jul%202017?OpenDocument) of the cards are selected for a sample, and most of the rest carefully imputed.  Many of the methods I'm using below could well struggle if there's even moderate errors or poor assumptions made in this sampling or imputation process. The strange results produced by our New Zealand regression below could be an indication of uncertainty or inconsistency in this process as much as anything else.

But perhaps more importantly, given the way that migration is defined under the 12/16 rule, there's absolutely nothing preventing these 'short term' travels actually contributing to Net Overseas Migration, and hence not explaining a discrepancy between that number and Net Movements.  Two six-month trips a couple of months apart will constitute migration.  As will a two-week trip, if some was travelling a lot in the previous year. 

## Missing arrivals instead?

Trying not to be disheartened, we could look to see whether what data we do have could still clarify things further. So far we've only looked at half (or less) of the story.  We have short-term arrivals as well:

```{r, warning=FALSE, include=F, message=FALSE, fig.align="center", fig.cap="Short term Arrivals have been flat for a large share of the time on record"}

plot <- sheet_340106 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_col(data = joint_sheet_310101 %>% filter(Date > "1991-12-01 GMT"), aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6, col = "grey")+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m, col = "6 to 12 months"))+
  scale_y_continuous(labels = scales::comma, limits = c(0, 3200000)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  labs(title = "Short Term Arrivals Previous 12 Months")+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))


```

Here a couple of things are striking.  In particular, the under-1-week movement trend is ususally the highest, followed by 1-2 weeks.  People arriving in Australia seem to report a far shorter intended stay than those leaving.  And, the total number of arrivals is far far lower than the departures.  This is also consistent with the hypothesis I've [outlined earlier](https://www.quixoticquant.com/post/the-state-of-debate-a-bird-s-eye-on-migration/), that we're a hard pace to get to for a short trip, but a good place to leave from for one. 

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Departures of longer than one month have the largest contribution to persons absent"}
# Impact of Departures by Time
plot <- sheet_340106 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m*22/365, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m*11/365, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m*4/365, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m*46/365, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m*77/365, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m*165/365, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m*273/365, col = "6 to 12 months"))+
  labs(title = "Person-Years present from Short Term Arrivals")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))

days.vec <- c(4/365, 11/365, 22/365, 46/365, 77/365, 165/365, 273/365)
days.tab <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee.Pre.12m" ,  "Num.of.mov.1.and.und.2.wee.Pre.12m", "Num.of.mov.2.wee.and.und.1.mon.Pre.12m",
"Num.of.mov.1.and.und.2.mon.Pre.12m", "Num.of.mov.2.and.und.3.mon.Pre.12m", "Num.of.mov.3.and.und.6.mon.Pre.12m", "Num.of.mov.6.and.und.12.mon.Pre.12m")) %>% 
  select(Component, days.vec) %>% 
  mutate(monthly.vec = days.vec*12)

end.vec.a <- sheet_340106 %>% 
  select(Num.of.mov.Und.1.wee.Pre.12m:Num.of.mov.6.and.und.12.mon.Pre.12m) %>% 
  tail(n = 1) %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column(var = c("Component"))
colnames(end.vec) <- c("Component", "Movement.end")

mid.vec.a <- sheet_340106 %>% 
  filter(Date > "2001-12-30 GMT") %>% 
  filter(Date < "2002-01-31 GMT") %>% 
  select(Num.of.mov.Und.1.wee.Pre.12m:Num.of.mov.6.and.und.12.mon.Pre.12m) %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column(var = c("Component"))
colnames(mid.vec) <- c("Component", "Movement.mid")

days.tab.a <- days.tab %>% 
  inner_join(end.vec, by = "Component") %>% 
  inner_join(mid.vec, by = "Component")

days.tab.a <- days.tab.a %>% 
  mutate(mid.absent = Movement.mid*days.vec, end.absent = Movement.end*days.vec)

present.shift <- days.tab.a %>% 
  summarise(present2001 = sum(mid.absent), present2017 = sum(end.absent))
```

Here the plausible 'second-half' of the story emerges.  By far the largest contributor to 'person-years' present in Australia from short-term arrivals is actually from the longest intended trips, of over six months, and the second-longest from 3-6 month visits.  Importantly, there's a far larger possibility that these 'short-term' visits will wind up being counted in Net Overseas Migration.  Students or backpackers who stack up a couple of 6+ month visits inside a couple of years (probably even more likely than staying continuously) will almost certainly officially 'migrate'.  In stark contrast to the case for departures, the shorter categories are relatively tiny, and didn't grow at all during the period when the missing million emerged.  This goes a lot further towards explaining the true origins of the Missing-Million, and is further supports the hypothesis outline in my earlier post. The sorts of 'visitors' we get tend to be longer-term visitors, but still visitors, where as our travel outwards tends to be for faster visits.

Again, summing the total 'person-years' accounted for by this trend, we find there are just under 800,000 people in 2017, and just over 400,000 in 2001.  Three quarters of this increase can be accounted for by movements where the stated intent longer than six months. If a large fraction of these are counted within migration, and I think it's almost certain that they are, then the person-years present due to short term visitors would barely have moved.  If a significant share of the 3-6 month intentions were also counted as 'migration', then the person-years present would have moved backwards due to short-term arrivals.  This could explain a further part of the discrepancy between Net Overseas Migration.  However, it also seems likely to not add up to be enough to reach the million.

To confirm the failing significance of passengers' stated intentions, it looks like the ABS is also going to abandon these particular series.

## An interim summary
So far, having just eyeballed some data and done a couple of quick calculations to see how the numbers stack up, it appears:

1. The Missing Million grew to half its height while travel to Indonesia was low and flat, and travel to New Zealand was increasing.  
2. Person-year absent due to 'short-term' departures is driven by travel between two-weeks and two months. Very short holidays don't contribute much.  But all this data on stated intent can't account for the Missing Million.
3. Person-years present due to arrivals is driven by long stays of 3+ months, and overwhelmingly by 6+ months.  If a large slice of these are counted in 'Net Overseas Migration' movements, the loss of arrivals could account for another part of the Missing Million.
4. The data is fraught with uncertainty in any case, and all our work here should be taken with a grain of salt.

## Unpacking correlation

What we haven't yet tackled seriously is the assumption of a high-overlap between the four different trends, or at least the three which we have data on.  To establish or refute this, it's better that we look at the information available to us, in its raw (monthly) format.  As we can see, the intense seasonality present in some of these time-series can provide us with a key to possible analytic mechanism that could investigate the plausible degree of overlap.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Monthly departures by duration show clear seasonality"}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Und.1.wee, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon, col = "6 to 12 months"))+
  labs(title = "Monthly Short Term Resident Departures")+
  scale_y_continuous(labels = scales::comma, limits = c(0, 420000)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Different Countries also exhibit different seasonal patterns."}

plot <- sheet_340109 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col = "NZ"))+
  geom_line(aes(y = Numb.of.move.Indo, col = "Indonesia"))+
  geom_line(aes(y = Numb.of.move.Unit.Stat.of.Amer, col = "USA"))+
  geom_line(aes(y = Numb.of.move.UK.CIs.IOM, col = "UK"))+
  geom_line(aes(y = Numb.of.move.Thai, col = "Thailand"))+
  geom_line(aes(y = Numb.of.move.Chin, col = "China"))+
  geom_line(aes(y = Numb.of.move.Sing, col = "Singapore"))+
  geom_line(aes(y = Numb.of.move.Fiji, col = "Fiji"))+
  geom_line(aes(y = Numb.of.move.Japa, col = "Japan"))+
  labs(title = "Short Term Monthly Departures by Destination")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 80, b = 50, r = 70))


```

(Note, one can click the countries in the legend to turn off a series, or double-click a country to show a single series.  This helps to isolate or inspect individual trends.)

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

plot <- sheet_340109 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.East.Asia, col = "SE Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Ocea.and.Anta, col = "Oceana"))+
  geom_line(aes(y = Numb.of.move.Tota.Amer, col = "America"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.East.Asia, col = "NE Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.West.Euro, col = "NW Europe"))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.and.East.Euro, col = "SE Europe"))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.and.Cent.Asia, col = "Sourth Cent Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.Afri.and.the.Midd.East, col = "North Africa Middle East"))+
  geom_line(aes(y = Numb.of.move.Tota.Sub.Saha.Afri, col = "Sub Saharan Africa"))+
  
  labs(title = "Short Term Movements Departures")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))
```


From the above two charts it can be quite easily seen that the slump in departures growth that occurred in the mid-2000s and the dramatic elevation in it after about 2008, is concentrated in South East Asia and to some extent the USA. This is again consistent with Australia now competing with other attractive pacific destinations as holiday spots, but probably acting as something of a home-base for people wanting to explore South East Asia.  Arrive long-term to Australia, but leave short-term, frequently, to explore Asia.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Monthly Departures by Purpose also show contrasting seasonal structure"}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Con, col = "Conferences"))+
  geom_line(aes(y = Num.of.mov.Hol, col = "Holidays"))+
  geom_line(aes(y = Num.of.mov.Bus, col = "Business"))+
  geom_line(aes(y = Num.of.mov.Emp, col = "Employment"))+
  geom_line(aes(y = Num.of.mov.Edu, col = "Education"))+
  geom_line(aes(y = Num.of.mov.Vis.fri, col = "Visit Friends"))+
  
  labs(title = "Short Term Movements Departures by Purpose")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 80, b = 60, r = 70))

```


It should be noted here that while holidays have been the largest growing single component, there's clear evidence here that visiting friends is a significant driver of the December annual peak in departures.  This seems also to align with a strong December Peak in departures that occurs in departures to New Zealand (which is less present in departures to Indonesia), and also in slightly longer travel times, including 1-2 month visits.  

All this strongly points towards some significant overlap between the largest contributors to 'persons absent' due to departures being New Zealanders visiting friends or family back home, rather than boomers in Bali, though the degree of the overlap is still hard to prove.

## Dive with me baby!!

We could go further to try to substantiate that claim using some more advanced statistical techniques, for those who want to dive even deeper into the data.  For example, we could use a decomposing function to isolate the seasonal and trend components in a given time series, such as this call of `stl()` does this using the loess smoother:

```{r, warning = FALSE, message = FALSE, fig.align="center", fig.cap = "A decomposition of departures for the purpose of Visiting Friends or Family"}

tsobj <- sheet_3401010$Num.of.mov.Vis.fri %>% 
  ts(frequency = 12)

plot(stl(tsobj, s.window = "periodic"))



```

We could then compare the seasonal component (in the second pane) with other seasonal structures in different category types.  However, as can be seen from the asymmetric errors in the bottom pain, the growth in the seasonality of the series isn't perfectly accounted for.  This highlights that the structure of the seasonality is subject to change as well within the time-series.  Again, my preferred method to get a sense of how this might be the case is to use the Mk 1 eyeball again for a quick check.  Another visual representation of the raw data is to overlay the different years on top of one another.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="A clear december spike exists for departures to visit Friends"}
sheet_3401010 <- sheet_3401010 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_3401010 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Num.of.mov.Vis.fri, col = year))+
  labs(title = "Stacked  years of 'visiting friends' departures ")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 60, r = 70),
        legend = list(y = 0.9, x = 0.1))

```

And one can see intuitively how there could be a significant overlap with this sort of series:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="A clear december spike exists for departures for 1-2 months"}
sheet_3401010 <- sheet_3401010 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_3401010 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Num.of.mov.1.and.und.2.mon, col = year))+
  labs(title = "Stacked  years of 1-2 Month departures ")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 60, r = 70),
        legend = list(y = 0.9, x = 0.1))

```
And also might have quite a strong overlap with this sort of series:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Seasonality of movements to New Zealand also exhibits a December Spike"}
sheet_340109 <- sheet_340109 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_340109 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Numb.of.move.New.Zeal, col = year))+
  labs(title = "Short Term Departures to New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 70, r = 70),
        legend = list(y = 0.9, x = 0.1))



```
Or at least, one could say it probably has a stronger overlap than with this sort of series:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Seasonality of movements to Indonesia exhibits no December Spike"}
sheet_340109 <- sheet_340109 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_340109 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Numb.of.move.Indo, col = year))+
  labs(title = "Short Term Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 70, r = 70),
        legend = list(y = 0.9, x = 0.1))



```

Which might have more of an overlap with this sort of series:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Seasonality of Holiday Movements"}
sheet_3401010 <- sheet_3401010 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_3401010 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Num.of.mov.Hol, col = year))+
  labs(title = "Monthly Holiday Movements")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 100, b = 70, r = 70),
        legend = list(y = 0.9, x = 0.1))


```

All in all, this really just serves to pose more properly the question: What is the actual composition of these time series, in terms of the other ones?  Are departures to Indonesia predominantly short, and departures to New Zealand substantially longer?  

## Dive Deeper
It might be possible to attain to substantiate this sort of eye-balling activity statistically using a multivariate regression.  Essentially all this is doing is seeing which combinations of one division of departures corresponds best to a particular series in another characterisation. This is easily done, though care should be taken when interpreting the results, a summary of which might look like this:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis Unconstrained"}

#########
kiwis <- sheet_340109 %>% 
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor <- inner_join(sheet_3401010, kiwis, by = "Date")
kiwi_regressor <- select(kiwi_regressor, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor <- kiwi_regressor %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor)  # Regress y on everything (but Year)
summary(mod)

```

Probably an easier way to understand the output is to say that a model was constructed attempting to reproduce the data of Departures to New Zealand, by adding different amounts of all the series for different durations of departure.  The model that was fitted to the data ended up looking like this:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis Unconstrained"}
model <- tibble(fit =mod$fitted.values)
model <- bind_cols(model, kiwi_length_regressor %>% select(Date, Numb.of.move.New.Zeal ))
model <- model %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")

smoothlm <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =model) 
smoothrsquared <- summary(smoothlm)$r.squared
#smoothrsquared

rsquared <- summary(mod)$r.squared

plot <- ggplot(model, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.New.Zeal.Pre.12m/12, col = "12 Month Original"))+
    scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Un-Constrained Model Short-Term Departures to New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  geom_text(x = min(as.numeric(model$Date[53])), y=80000, label=paste0("Monthly R Squared: ", round(rsquared, digits = 3), 
                                                                                      "\n12 Month R Squared: ", round(smoothrsquared, digits = 3), size = 3))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 70, b = 70, r = 70),
         legend = list(y = 0.95, x = 0.05))

```

And was composed of the following weightings of the length of departure series:

#Uncon Kiwi Coefs
```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Unconstrained Coefficients"}

coefs <- summary(mod)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee" ,          "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs, aes(x = Component, fill = log(Pr.abs.t)))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficient Estimates from Unconstrained Model New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

This is shows something odd, it appears that there's a negative weighting of several of a couple of the components.  This doesn't make any sense, as you can't have a negative number of departures.  In addition I've shaded the colours here with the log of a variable of the output of the model called Pr(>|t|), which gives an indication of the likelihood that of this original data occurring if that co-efficient wasn't present at all.  In other words, darker colours give a higher degree of confidence that that particular coefficient weighting is likely to be good.

Seeing relatively light colours for slightly negative coefficient values is probably ok, (as it's quite probable that having none of this component, or a very small positive value wouldn't throw out the fit too much) but finding an extremely dark one for a large negative value means that the results are overall likely to be somewhat unrealistic. It appears that the negative value is likely compensating for over-weighting of the other two components to the left and right.  To understand why, let's look again at what the spectrums suggest:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="A clear May spike exists for departures for 3-6 months"}
sheet_3401010 <- sheet_3401010 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_3401010 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Num.of.mov.3.and.und.6.mon, col = year))+
  labs(title = "Stacked  years of 3-6 Month departures ")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 60, r = 70),
        legend = list(y = 0.9, x = 0.1))

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="A clear december spike exists for departures for 6-12 months"}
sheet_3401010 <- sheet_3401010 %>% 
  mutate(year = year(Date)) %>% 
  mutate(month = month(Date))

plot <- sheet_3401010 %>% 
  ggplot(aes(x = month, text = as_date(Date)))+
  geom_line(aes( y = Num.of.mov.6.and.und.12.mon, col = year))+
  labs(title = "Stacked  years of 6-12 Month departures ")+
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(breaks = c(1:12))+
  theme(axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
layout(margin=list(l=70, t = 80, b = 60, r = 70),
        legend = list(y = 0.9, x = 0.1))

```

Here we can see why the regression came up with this result.  Departures to New Zealand slump in May each year (see Figure 19), and 3-6 month departures have a peak in May.  Subtracting that component consequently improves the fit substantially, though it's not a physically possible result.  Overall, it appears that my attempt to get these statistical methods to substantiate a proposed split between the different visit duration seems to have failed.  It's probable that in New Zealand's case the implicit assumption (that the distribution of trip-lengths to New Zealand is relatively stable over time) doesn't hold well. We'll relax this assumption a little later to see if it improves things, but first let's just check to see how close a more-realistic model can come.

To get a more realistic model, we can re-run the regression with a constraint that requires all the co-efficients to be non-negative.  Happily there's an R package called `nnls` by Katharine Mullen which can quickly create such a model.  The result is this:

#Kiwi Constrained
```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis Constrained"}
regr.names <- kiwi_length_regressor %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(kiwi_length_regressor[,regr.names])
B <- kiwi_length_regressor$Numb.of.move.New.Zeal
nnmod <- nnls(A,B)
coef.nnmod <- coef(nnmod)
pred.nnmod <- as.vector(coef.nnmod%*%t(A))
#coef.nnmod

nnmodel <- tibble(fit =nnmod$fitted[,1])
nnmodel <- bind_cols(nnmodel, kiwi_length_regressor %>% select(Date, Numb.of.move.New.Zeal ))
nnmodel <- nnmodel %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
nndummy <- lm(nnmodel$fit ~ nnmodel$Numb.of.move.New.Zeal)
#summary(nndummy)
rsquared <- summary(nndummy)$r.squared

smoothnnlm <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =nnmodel) 
smoothrsquared <- summary(smoothnnlm)$r.squared
#smoothrsquared

plot <- ggplot(nnmodel, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.New.Zeal.Pre.12m/12, col = "12 Month Original"))+
  scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Non-Negative Constrained Modeling of Short Term Departures to New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  geom_text(x = min(as.numeric(model$Date[56])), y=90000, label=paste0("Monthly R Squared: ", round(rsquared, digits = 3), 
                                                                                      "\n12 Month R Squared: ", round(smoothrsquared, digits = 3), size = 3))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 70, b = 60, r = 60),
         legend = list(y = 0.95, x = 0.05))

weights <- kiwi_length_regressor %>% 
  select(-Date, -Numb.of.move.New.Zeal) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

day.weights <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon") )


```

This produces two curious results.  It shows that with a constrained model not nearly as much of the seasonal fluctuation can be incorporated, and the December spikes in particular don't match up as well.  However, in an odd twist of fate, the fit of the 12-month running average is actually better, with a slightly higher R-squared match.  This suggests that the adjustment made to the coefficients between the unconstrained model and this one are almost certainly more in line with long-term, as opposed to intra-year trends.  By plotting the co-efficients, we can see what that is:

#Con Kiwi Coefs
```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Positive Coefficients"}

coefs <- coef.nnmod %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs) <- c("Estimate", "Component")
coefs <- coefs %>% 
  select("Component", "Estimate")

coefs$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs, aes(x = Component))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficient Estimates from Constrained Model")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=60, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))
```


Not being able to include a large negative weighting means that the magnitude of the other positive weightings also decreases.  In this case, I strongly suspect that the lower weighting of 6-12 month departures (which were completely flat in overall trend) actually assisted in better matching the trend.  Sadly `nnls()` doesn't yet have as easy a way of pulling out `Pr(>|t|)` so I wasn't able to give that indication of confidence with a colour scaling.

The graph also shows that we have a weighting of 6-12 months that is over one, which is also unrealistic, since we can't have 120% of 6-12 month departures all going to New Zealand.  With more time and resources there would certainly be means of further constraining the models, including with the outputs of other regressions on other variables, to make a fuller and more consistent model. But first let's just multiply these 'weightings' by the mean actual number of travel undertaken under each departure length, and then by the average length of stay, to convert the coefficients back into numbers which are easier to make some sense of: numbers of departures monthly, and number of 'person-years' absent that could be attributable to that flow.



```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Positive Coefficients Weighted"}

coefs <- coefs %>% 
  inner_join(weights) %>% 
  inner_join(day.weights) 
colnames(coefs) <- c("Component", "Estimate", "Weight", "days.vec")

coefs <- coefs %>% 
  mutate(departures.estimate = Estimate*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)

coefs.g <- coefs %>% 
  gather(type, value, -Component, -Estimate, -Weight, - days.vec)

coefs.g$Component <- factor(coefs.g$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = value, fill = type), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Impact of NZ Departures by Component")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.05))
```

This leaves us in a somewhat unsatisfying place.  It indicates that there might be a significant number of people 'absent' in New Zealand due to longer trips, but we also know that it's impossible that more than 100% of the trips over 6 months went to New Zealand.  The model isn't producing realistic values yet, so we can't have any real confidence in the levels indicated there.  In addition, these values are taken for a mean for the entire period, which isn't actually that helpful since we're actually most interested in how the trends look over time.

## Differentiating with respect to time
This means that it's time to break the data up into different time increments and see if we get more realistic data, or clearer trends, by stepping through time.  Incidentally taking a derivative with respect to some sensible dimension (in this case time) is also my favourite technique for rescuing some sensible, more confident conclusions when there's extremely high uncertainty in a particular level that's been measured.  Since derivatives aren't dependent on a particular level, only a trend, we could still get a sense of whether the significance of these components is increasing or decreasing over time with greater confidence.


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis Unconstrained"}

#########
kiwis.e <- sheet_340109 %>% 
  filter(Date < "2000-01-01 GMT") %>% 
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor.e <- inner_join(sheet_3401010, kiwis.e, by = "Date")
kiwi_regressor.e <- select(kiwi_regressor.e, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor.e <- kiwi_regressor.e %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.e <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor.e)  
model.e <- tibble(fit =mod.e$fitted.values)
model.e <- bind_cols(model.e, kiwi_length_regressor.e %>% select(Date, Numb.of.move.New.Zeal ))
model.e <- model.e %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
model.e <- model.e %>% 
  mutate(stage = "early")

smoothlm.e <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =model.e) 
smoothrsquared.e <- summary(smoothlm.e)$r.squared
rsquared.e <- summary(mod.e)$r.squared
rows.e <- kiwis.e$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

#########
kiwis.m <- sheet_340109 %>% 
  filter(Date >= "2000-01-01 GMT", Date < "2010-01-01") %>%  
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor.m <- inner_join(sheet_3401010, kiwis.m, by = "Date")
kiwi_regressor.m <- select(kiwi_regressor.m, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor.m <- kiwi_regressor.m %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.m <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor.m)  
model.m <- tibble(fit =mod.m$fitted.values)
model.m <- bind_cols(model.m, kiwi_length_regressor.m %>% select(Date, Numb.of.move.New.Zeal ))
model.m <- model.m %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
model.m <- model.m %>% 
  mutate(stage = "mid")

smoothlm.m <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =model.m) 
smoothrsquared.m <- summary(smoothlm.m)$r.squared
rsquared.m <- summary(mod.m)$r.squared
rows.m <- kiwis.m$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

#########
kiwis.l <- sheet_340109 %>% 
  filter(Date >= "2010-01-01 GMT") %>%  
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor.l <- inner_join(sheet_3401010, kiwis.l, by = "Date")
kiwi_regressor.l <- select(kiwi_regressor.l, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor.l <- kiwi_regressor.l %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.l <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor.l)  
model.l <- tibble(fit =mod.l$fitted.values)
model.l <- bind_cols(model.l, kiwi_length_regressor.l %>% select(Date, Numb.of.move.New.Zeal ))
model.l <- model.l %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
model.l <- model.l %>% 
  mutate(stage = "late")

smoothlm.l <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =model.l) 
smoothrsquared.l <- summary(smoothlm.l)$r.squared
rsquared.l <- summary(mod.l)$r.squared
rows.l <- kiwis.l$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

model.f <- model.e %>% 
  bind_rows(model.m, model.l)

plot <- ggplot(model.f, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.New.Zeal.Pre.12m/12, col = "12 Month Original"))+
    scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Un-Constrained Model Short-Term Departures to New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  geom_text(x = min(as.numeric(model.f$Date[rows.e-50])), y=70000, label=paste0("R^2: ", round(rsquared.e, digits = 3), "\nTrend R^2: ", round(smoothrsquared.e, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(model.f$Date[rows.m+rows.e-50])), y=150000, label=paste0("R^2: ", round(rsquared.m, digits = 3), "\nTrend R^2: ", round(smoothrsquared.m, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(model.f$Date[rows.m+rows.e+rows.l-30])), y=25000, label=paste0("R^2: ", round(rsquared.l, digits = 3), "\nTrend R^2: ", round(smoothrsquared.l, digits = 3), size = 2))+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e])), linetype = 3)+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e+rows.m])), linetype = 3)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 70, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

This graph shows the results of running three different multi-variate regressions on the three time-intervals indicated.  As you can see, the fits now look quite impressive.  However, the unconstrained model still relied upon some unrealistic methods to get such good results:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Unconstrained Coefficients"}

coefs.e <- summary(mod.e)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.e) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.e <- coefs.e %>% 
  mutate(stage = "early")

coefs.m <- summary(mod.m)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.m) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.m <- coefs.m %>% 
  mutate(stage = "mid")

coefs.l <- summary(mod.l)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.l) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.l <- coefs.l %>% 
  mutate(stage = "late")

coefs.f <- coefs.e %>% 
  bind_rows(coefs.m, coefs.l)


coefs.f$Component <- factor(coefs.f$Component, levels = c("Num.of.mov.Und.1.wee" ,          "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.f$stage <- factor(coefs.f$stage, levels = c("early", "mid", "late"))

#p <- ggplot(mpg, aes(displ, cty)) + geom_point()
#p+facet_grid(. ~ cyl)

plot <- ggplot(data = coefs.f, aes(x = Component, fill = log(Pr.abs.t)))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficient Estimates from Unconstrained Model New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  facet_grid(. ~ stage)
ggplotly(plot, tooltip = c("y")) %>% 
  layout(margin=list(l=120, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

Again, in all three of these fits, the most important elements (dark colours) tended to be unrealistic, both extremely large (greater than 1), and negative.  The note-worthy exception, if anything, could be the improved significance and scale of very short-term trips in the middle period. But overall this result confirms little.  Let's see how constraining the coefficients works.


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis Constrained"}
#########
regr.names.e <- kiwi_length_regressor.e %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(kiwi_length_regressor.e[,regr.names.e])
B <- kiwi_length_regressor.e$Numb.of.move.New.Zeal
nnmod.e <- nnls(A,B)
coef.nnmod.e <- coef(nnmod.e)
nnmodel.e <- tibble(fit =nnmod.e$fitted[,1])
nnmodel.e <- bind_cols(nnmodel.e, kiwi_length_regressor.e %>% select(Date, Numb.of.move.New.Zeal ))
nnmodel.e <- nnmodel.e %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
nndummy.e <- lm(nnmodel.e$fit ~ nnmodel.e$Numb.of.move.New.Zeal)
rsquared.e <- summary(nndummy.e)$r.squared
smoothnnlm.e <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =nnmodel.e) 
smoothrsquared.e <- summary(smoothnnlm.e)$r.squared
coefs.e <- coef.nnmod.e %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.e) <- c("Estimate", "Component")
coefs.e <- coefs.e %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "early")
weights.e <- kiwi_length_regressor.e %>% 
  select(-Date, -Numb.of.move.New.Zeal) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.e <- coefs.e %>% 
  inner_join(weights.e, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.e) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.e <- coefs.e %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)
###################
#########
regr.names.m <- kiwi_length_regressor.m %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(kiwi_length_regressor.m[,regr.names.m])
B <- kiwi_length_regressor.m$Numb.of.move.New.Zeal
nnmod.m <- nnls(A,B)
coef.nnmod.m <- coef(nnmod.m)
nnmodel.m <- tibble(fit =nnmod.m$fitted[,1])
nnmodel.m <- bind_cols(nnmodel.m, kiwi_length_regressor.m %>% select(Date, Numb.of.move.New.Zeal ))
nnmodel.m <- nnmodel.m %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
nndummy.m <- lm(nnmodel.m$fit ~ nnmodel.m$Numb.of.move.New.Zeal)
rsquared.m <- summary(nndummy.m)$r.squared
smoothnnlm.m <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =nnmodel.m) 
smoothrsquared.m <- summary(smoothnnlm.m)$r.squared
coefs.m <- coef.nnmod.m %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.m) <- c("Estimate", "Component")
coefs.m <- coefs.m %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "mid")
weights.m <- kiwi_length_regressor.m %>% 
  select(-Date, -Numb.of.move.New.Zeal) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.m <- coefs.m %>% 
  inner_join(weights.m, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.m) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.m <- coefs.m %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)
###################

#########
regr.names.l <- kiwi_length_regressor.l %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(kiwi_length_regressor.l[,regr.names.l])
B <- kiwi_length_regressor.l$Numb.of.move.New.Zeal
nnmod.l <- nnls(A,B)
coef.nnmod.l <- coef(nnmod.l)
nnmodel.l <- tibble(fit =nnmod.l$fitted[,1])
nnmodel.l <- bind_cols(nnmodel.l, kiwi_length_regressor.l %>% select(Date, Numb.of.move.New.Zeal ))
nnmodel.l <- nnmodel.l %>% 
  month_mutate("Numb.of.move.New.Zeal") %>% 
  month_mutate("fit")
nndummy.l <- lm(nnmodel.l$fit ~ nnmodel.l$Numb.of.move.New.Zeal)
rsquared.l <- summary(nndummy.l)$r.squared
smoothnnlm.l <- lm(Numb.of.move.New.Zeal.Pre.12m ~ fit.Pre.12m, data =nnmodel.l) 
smoothrsquared.l <- summary(smoothnnlm.l)$r.squared
coefs.l <- coef.nnmod.l %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.l) <- c("Estimate", "Component")
coefs.l <- coefs.l %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "late")
weights.l <- kiwi_length_regressor.l %>% 
  select(-Date, -Numb.of.move.New.Zeal) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.l <- coefs.l %>% 
  inner_join(weights.l, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.l) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.l <- coefs.l %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)

###################

nnmodel.f <- nnmodel.e %>% 
  bind_rows(nnmodel.m,nnmodel.l)

plot <- ggplot(nnmodel.f, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.New.Zeal.Pre.12m/12, col = "12 Month Original"))+
  scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Non-Negative Modeling of Short Term Departures to New Zealand")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.e-50])), y=70000, label=paste0("R^2: ", round(rsquared.e, digits = 3),"\nTrend R^2: ", round(smoothrsquared.e, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.m+rows.e-50])), y=150000, label=paste0("R^2: ", round(rsquared.m, digits = 3),"\nTrend R^2: ", round(smoothrsquared.m, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.m+rows.l+rows.l-30])), y=40000, label=paste0("R^2: ", round(rsquared.l, digits = 3),"\nTrend R^2: ", round(smoothrsquared.l, digits = 3), size = 2))+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e])), linetype = 3)+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e+rows.m])), linetype = 3)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 70, b = 60, r = 60),
         legend = list(y = 0.9, x = 0.05))

weights.e <- kiwi_length_regressor.e %>% 
  select(-Date, -Numb.of.move.New.Zeal) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

day.weights <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon") )


```

Here we can see that the model was still able to reflect the overall trend quite well, however seasonal fluctuations were poorly accounted for, especially in the later period.  This strongly suggests that within each year there could be substantial shifts in the average trip-length of a visit to New Zealand.  This sounds quite plausible, as shorter holiday visits might be made to New Zealand in the winter for skiing, while longer visits to spend time with family back home might be more common in the larger summer holidays, in particular for the substantial NZ expat community that lives (substantially) in Australia.  I won't dive down that rabbit hole just now, instead let's check out how the coefficients for this constrained model looks, just to see how close to the realm of plausibility they lie.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Positive Coefficients"}

coefs.f <- coefs.e %>% 
  bind_rows(coefs.m, coefs.l)

coefs.g <- coefs.f %>% 
  gather(type, value, -Component, -Estimate, -Weight, - days.vec, -stage)

coefs.g$Component <- factor(coefs.g$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.g$stage <- factor(coefs.g$stage, levels = c("early", "mid", "late"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = Estimate), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficients for Departures to NZ in three decades")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())+
  facet_grid(.~stage)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=120, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.05))
```


If anything one could say that there's a lack of evidence that visits to New Zealand are short term, and weak evidence to suggest that an increasing share might be slightly longer, but the unrealistically large coefficients confirm most strongly that the model doesn't hold well.  Our time-invariance assumption on the intra-year level is failing.  But just to put an order-of-magnitude on the corresponding implied departures, and people absent, we should multiply by the relevant weights for each series, and estimated duration of absence:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NZ Departures Positive Coefficients Weighted"}



coefs.g$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.g$stage <- factor(coefs.g$stage, levels = c("early", "mid", "late"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = value, fill = type), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Impact of NZ Departures by Component")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())+
  facet_grid(.~stage)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.05))

```

This suggests that if there is a significant share of longer trips, it's these that are far more likely to constitute a larger share of the missing million.  However, even the shorter trips of a few weeks could plausibly contribute around 50,000 people of the Missing Million.

To make the most of an uncertain insight, I'll again revert to my favourite technique, compare it to something else, or take a derivative so to speak, so we can at least see how different it is to something else.  Let's have a look at a similar regression model for departures to Indonesia.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of balis Unconstrained"}

#########
balis <- sheet_340109 %>% 
  select(Date, Numb.of.move.Indo)
bali_regressor <- inner_join(sheet_3401010, balis, by = "Date")
bali_regressor <- select(bali_regressor, Date, Numb.of.move.Indo,  everything ())
bali_length_regressor <- bali_regressor %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor)  # Regress y on everything (but Year)
#summary(mod)
model <- tibble(fit =mod$fitted.values)
model <- bind_cols(model, bali_length_regressor %>% select(Date, Numb.of.move.Indo ))
model <- model %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")

smoothlm <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =model) 
smoothrsquared <- summary(smoothlm)$r.squared
#smoothrsquared

rsquared <- summary(mod)$r.squared

plot <- ggplot(model, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Indo, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.Indo.Pre.12m/12, col = "12 Month Original"))+
    scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Un-Constrained Model Short-Term Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  geom_text(x = min(as.numeric(model$Date[150])), y=80000, label=paste0("Monthly R Squared: ", round(rsquared, digits = 3), 
                                                                                      "\n12 Month R Squared: ", round(smoothrsquared, digits = 3), size = 3))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 70, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

This is an interesting contrast, since in this case the trend line (sum of previous 12 months divided by 12) doesn't actually fit much better than the monthly exact figures.  In fact, there are periods where the fitted line seems to do quite a good job at capturing the seasonal fluctuation, whilst the overall level is a bit off.  Unlike New Zealand, it looks a bit like the time-invariance assumption regarding the distribution of departures amongst the different intended lengths of travel holds quite well within a given year, but perhaps not so well in the larger drift of time.  

Let's inspect the model to see what sort of results we're getting:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Unconstrained Coefficients"}

coefs <- summary(mod)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee" ,          "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs, aes(x = Component, text = Pr.abs.t, fill = log(Pr.abs.t)))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficient Estimates from Unconstrained Model Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=60, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

This looks like a far better result.  We can see here that the component with the greatest statistical confidence (dark colour) is a positive component, and less than 1, which means that it's a realistic number.  The largest negatives also have the least significance statistically (lighter colour).  Overall this looks far better.  Let's see how whether it translates to a decent model with only-positive coefficients.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of balis Constrained"}
library(nnls)



regr.names <- bali_length_regressor %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(bali_length_regressor[,regr.names])
B <- bali_length_regressor$Numb.of.move.Indo
nnmod <- nnls(A,B)
coef.nnmod <- coef(nnmod)
pred.nnmod <- as.vector(coef.nnmod%*%t(A))
#coef.nnmod

nnmodel <- tibble(fit =nnmod$fitted[,1])
nnmodel <- bind_cols(nnmodel, bali_length_regressor %>% select(Date, Numb.of.move.Indo ))
nnmodel <- nnmodel %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
nndummy <- lm(nnmodel$fit ~ nnmodel$Numb.of.move.Indo)
#summary(nndummy)
rsquared <- summary(nndummy)$r.squared

smoothnnlm <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =nnmodel) 
smoothrsquared <- summary(smoothnnlm)$r.squared
#smoothrsquared

plot <- ggplot(nnmodel, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Indo, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.Indo.Pre.12m/12, col = "12 Month Original"))+
  scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Non-Negative Modeling of Short Term Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  geom_text(x = min(as.numeric(model$Date[150])), y=80000, label=paste0("Monthly R Squared: ", round(rsquared, digits = 3), 
                                                                                      "\n12 Month R Squared: ", round(smoothrsquared, digits = 3), size = 3))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 70, b = 60, r = 60),
         legend = list(y = 0.9, x = 0.05))

weights <- bali_length_regressor %>% 
  select(-Date, -Numb.of.move.Indo) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

day.weights <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon") )


```

It certainly does.  This model looks almost as good as the un-constrained one, with the exact fit almost as good, though the trend line in the middle period does slightly worse at keeping with the original data.  Examining the components of this model, we find a clear story emerging about short-term travel.


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Positive Coefficients"}

coefs <- coef.nnmod %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs) <- c("Estimate", "Component")
coefs <- coefs %>% 
  select("Component", "Estimate")

coefs$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs, aes(x = Component))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Positive Coefficients from Constrained Model Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=60, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))
```

In this respect, Cameron Murray looks like he was right, indeed travel to Indonesia does tend to be short term, or so it seems here.  What he was wrong about though was that this comprises a significant component of the Missing Million:


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Positive Coefficients Weighted"}

coefs <- coefs %>% 
  inner_join(weights) %>% 
  inner_join(day.weights) 
colnames(coefs) <- c("Component", "Estimate", "Weight", "days.vec")

coefs <- coefs %>% 
  mutate(departures.estimate = Estimate*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)

coefs.g <- coefs %>% 
  gather(type, value, -Component, -Estimate, -Weight, - days.vec)

coefs.g$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = value, fill = type), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Impact of Indonesia Departures by Component")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.6))
```

As we can see here, even a solid 35,000 departures per month only adds up to about 12,000 people continually absent over such a short trip.  However, this is only taking an average over the whole period, and we'd be negligent not to investigate how that might have changed over time.  Whilst it would be tempting to test a variety of change-point detection algorithms to optimise the selection of different breaks in the series, for consistency and expediency I've broken the series into the same intervals as I did for New Zealand, at the turn of the decade.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of balis Unconstrained"}

#########
balis.e <- sheet_340109 %>% 
  filter(Date < "2000-01-01 GMT") %>% 
  select(Date, Numb.of.move.Indo)
bali_regressor.e <- inner_join(sheet_3401010, balis.e, by = "Date")
bali_regressor.e <- select(bali_regressor.e, Date, Numb.of.move.Indo,  everything ())
bali_length_regressor.e <- bali_regressor.e %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.e <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor.e)  
model.e <- tibble(fit =mod.e$fitted.values)
model.e <- bind_cols(model.e, bali_length_regressor.e %>% select(Date, Numb.of.move.Indo ))
model.e <- model.e %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
model.e <- model.e %>% 
  mutate(stage = "early")

smoothlm.e <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =model.e) 
smoothrsquared.e <- summary(smoothlm.e)$r.squared
rsquared.e <- summary(mod.e)$r.squared
rows.e <- balis.e$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

#########
balis.m <- sheet_340109 %>% 
  filter(Date >= "2000-01-01 GMT", Date < "2010-01-01") %>%  
  select(Date, Numb.of.move.Indo)
bali_regressor.m <- inner_join(sheet_3401010, balis.m, by = "Date")
bali_regressor.m <- select(bali_regressor.m, Date, Numb.of.move.Indo,  everything ())
bali_length_regressor.m <- bali_regressor.m %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.m <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor.m)  
model.m <- tibble(fit =mod.m$fitted.values)
model.m <- bind_cols(model.m, bali_length_regressor.m %>% select(Date, Numb.of.move.Indo ))
model.m <- model.m %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
model.m <- model.m %>% 
  mutate(stage = "mid")

smoothlm.m <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =model.m) 
smoothrsquared.m <- summary(smoothlm.m)$r.squared
rsquared.m <- summary(mod.m)$r.squared
rows.m <- balis.m$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

#########
balis.l <- sheet_340109 %>% 
  filter(Date >= "2010-01-01 GMT") %>%  
  select(Date, Numb.of.move.Indo)
bali_regressor.l <- inner_join(sheet_3401010, balis.l, by = "Date")
bali_regressor.l <- select(bali_regressor.l, Date, Numb.of.move.Indo,  everything ())
bali_length_regressor.l <- bali_regressor.l %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)
####

mod.l <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor.l)  
model.l <- tibble(fit =mod.l$fitted.values)
model.l <- bind_cols(model.l, bali_length_regressor.l %>% select(Date, Numb.of.move.Indo ))
model.l <- model.l %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
model.l <- model.l %>% 
  mutate(stage = "late")

smoothlm.l <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =model.l) 
smoothrsquared.l <- summary(smoothlm.l)$r.squared
rsquared.l <- summary(mod.l)$r.squared
rows.l <- balis.l$Date %>% 
  row_number() %>% 
  tail(n = 1)
####################

model.f <- model.e %>% 
  bind_rows(model.m, model.l)

plot <- ggplot(model.f, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Indo, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.Indo.Pre.12m/12, col = "12 Month Original"))+
    scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Un-Constrained Model Short-Term Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  geom_text(x = min(as.numeric(model.f$Date[rows.e-50])), y=50000, label=paste0("R^2: ", round(rsquared.e, digits = 3), "\nTrend R^2: ", round(smoothrsquared.e, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(model.f$Date[rows.m+rows.e-50])), y=75000, label=paste0("R^2: ", round(rsquared.m, digits = 3), "\nTrend R^2: ", round(smoothrsquared.m, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(model.f$Date[rows.m+rows.e+rows.l-30])), y=25000, label=paste0("R^2: ", round(rsquared.l, digits = 3), "\nTrend R^2: ", round(smoothrsquared.l, digits = 3), size = 2))+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e])), linetype = 3)+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e+rows.m])), linetype = 3)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 70, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

We can see now that the middle-section does far better at capturing the trend, and overall the fit looks quite good.  Let's see how the coefficients change in the three periods.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Unconstrained Coefficients"}

coefs.e <- summary(mod.e)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.e) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.e <- coefs.e %>% 
  mutate(stage = "early")

coefs.m <- summary(mod.m)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.m) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.m <- coefs.m %>% 
  mutate(stage = "mid")

coefs.l <- summary(mod.l)$coefficients %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != "(Intercept)")
colnames(coefs.l) <- c("Component", "Estimate", "Std.Error", "t.value", "Pr.abs.t")
coefs.l <- coefs.l %>% 
  mutate(stage = "late")

coefs.f <- coefs.e %>% 
  bind_rows(coefs.m, coefs.l)


coefs.f$Component <- factor(coefs.f$Component, levels = c("Num.of.mov.Und.1.wee" ,          "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.f$stage <- factor(coefs.f$stage, levels = c("early", "mid", "late"))

#p <- ggplot(mpg, aes(displ, cty)) + geom_point()
#p+facet_grid(. ~ cyl)

plot <- ggplot(data = coefs.f, aes(x = Component, text = Pr.abs.t, fill = log(Pr.abs.t)))+
  geom_bar(aes(y = Estimate), position = "stack", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficient Estimates from Unconstrained Model Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  facet_grid(. ~ stage)
ggplotly(plot, tooltip = c("y", "text")) %>% 
  layout(margin=list(l=110, t = 80, b = 120, r = 70),
         legend = list(y = 0.9, x = 0.05))

```

Perhaps the most striking feature here is the prevalence of some larger negative co-efficients in the middle period.  This is intriguing, and suggests overall that the model functions less well in this period, again most probably because the time-invariance assumption holds less well.  The other significant trend is that in the late period there's a substantial shift towards longer travel.  Let's see if those trends persist in a constrained model with positive coefficients.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of balis Constrained"}
#########
regr.names.e <- bali_length_regressor.e %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(bali_length_regressor.e[,regr.names.e])
B <- bali_length_regressor.e$Numb.of.move.Indo
nnmod.e <- nnls(A,B)
coef.nnmod.e <- coef(nnmod.e)
nnmodel.e <- tibble(fit =nnmod.e$fitted[,1])
nnmodel.e <- bind_cols(nnmodel.e, bali_length_regressor.e %>% select(Date, Numb.of.move.Indo ))
nnmodel.e <- nnmodel.e %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
nndummy.e <- lm(nnmodel.e$fit ~ nnmodel.e$Numb.of.move.Indo)
rsquared.e <- summary(nndummy.e)$r.squared
smoothnnlm.e <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =nnmodel.e) 
smoothrsquared.e <- summary(smoothnnlm.e)$r.squared
coefs.e <- coef.nnmod.e %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.e) <- c("Estimate", "Component")
coefs.e <- coefs.e %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "early")
weights.e <- bali_length_regressor.e %>% 
  select(-Date, -Numb.of.move.Indo) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.e <- coefs.e %>% 
  inner_join(weights.e, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.e) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.e <- coefs.e %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)
###################
#########
regr.names.m <- bali_length_regressor.m %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(bali_length_regressor.m[,regr.names.m])
B <- bali_length_regressor.m$Numb.of.move.Indo
nnmod.m <- nnls(A,B)
coef.nnmod.m <- coef(nnmod.m)
nnmodel.m <- tibble(fit =nnmod.m$fitted[,1])
nnmodel.m <- bind_cols(nnmodel.m, bali_length_regressor.m %>% select(Date, Numb.of.move.Indo ))
nnmodel.m <- nnmodel.m %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
nndummy.m <- lm(nnmodel.m$fit ~ nnmodel.m$Numb.of.move.Indo)
rsquared.m <- summary(nndummy.m)$r.squared
smoothnnlm.m <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =nnmodel.m) 
smoothrsquared.m <- summary(smoothnnlm.m)$r.squared
coefs.m <- coef.nnmod.m %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.m) <- c("Estimate", "Component")
coefs.m <- coefs.m %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "mid")
weights.m <- bali_length_regressor.m %>% 
  select(-Date, -Numb.of.move.Indo) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.m <- coefs.m %>% 
  inner_join(weights.m, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.m) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.m <- coefs.m %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)
###################

#########
regr.names.l <- bali_length_regressor.l %>% 
  select(Num.of.mov.Und.1.wee:Num.of.mov.6.and.und.12.mon) %>% 
  colnames() %>% 
  as.vector()

A <- as.matrix(bali_length_regressor.l[,regr.names.l])
B <- bali_length_regressor.l$Numb.of.move.Indo
nnmod.l <- nnls(A,B)
coef.nnmod.l <- coef(nnmod.l)
nnmodel.l <- tibble(fit =nnmod.l$fitted[,1])
nnmodel.l <- bind_cols(nnmodel.l, bali_length_regressor.l %>% select(Date, Numb.of.move.Indo ))
nnmodel.l <- nnmodel.l %>% 
  month_mutate("Numb.of.move.Indo") %>% 
  month_mutate("fit")
nndummy.l <- lm(nnmodel.l$fit ~ nnmodel.l$Numb.of.move.Indo)
rsquared.l <- summary(nndummy.l)$r.squared
smoothnnlm.l <- lm(Numb.of.move.Indo.Pre.12m ~ fit.Pre.12m, data =nnmodel.l) 
smoothrsquared.l <- summary(smoothnnlm.l)$r.squared
coefs.l <- coef.nnmod.l %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
colnames(coefs.l) <- c("Estimate", "Component")
coefs.l <- coefs.l %>% 
  select("Component", "Estimate") %>% 
  mutate(stage = "late")
weights.l <- bali_length_regressor.l %>% 
  select(-Date, -Numb.of.move.Indo) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))
coefs.l <- coefs.l %>% 
  inner_join(weights.l, by = "Component") %>% 
  inner_join(day.weights, by = "Component")
colnames(coefs.l) <- c("Component","Estimate", "stage", "Weight", "days.vec")
coefs.l <- coefs.l %>% 
  mutate(departures.estimate = as.numeric(Estimate)*Weight) %>% 
  mutate(Absent.Persons.Est = departures.estimate*days.vec*12)

###################

nnmodel.f <- nnmodel.e %>% 
  bind_rows(nnmodel.m,nnmodel.l)

plot <- ggplot(nnmodel.f, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Indo, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"), alpha = 0.8)+
  geom_line(aes(x = Date, y = fit.Pre.12m/12, col = "12 Month fitted"))+
  geom_line(aes(x = Date, y = Numb.of.move.Indo.Pre.12m/12, col = "12 Month Original"))+
  scale_colour_manual("", 
                      breaks = c("Original", "Fitted", "Past 12 Trend Fitted", "Past 12 Trend Original"),
                      values = c("green", "blue", "red", "black"))+
  labs(title = "Non-Negative Modeling of Short Term Departures to Indonesia")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.e-50])), y=50000, label=paste0("R^2: ", round(rsquared.e, digits = 3),"\nTrend R^2: ", round(smoothrsquared.e, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.m+rows.e-50])), y=75000, label=paste0("R^2: ", round(rsquared.m, digits = 3),"\nTrend R^2: ", round(smoothrsquared.m, digits = 3), size = 2))+
  geom_text(x = min(as.numeric(nnmodel.f$Date[rows.m+rows.l+rows.l-20])), y=30000, label=paste0("R^2: ", round(rsquared.l, digits = 3),"\nTrend R^2: ", round(smoothrsquared.l, digits = 3), size = 2))+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e])), linetype = 3)+
  geom_vline(xintercept = min(as.numeric(model.f$Date[rows.e+rows.m])), linetype = 3)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=80, t = 70, b = 60, r = 60),
         legend = list(y = 0.9, x = 0.05))

weights.e <- bali_length_regressor.e %>% 
  select(-Date, -Numb.of.move.Indo) %>% 
  colMeans() %>% 
  tibble(Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

day.weights <- tibble(days.vec, Component = c("Num.of.mov.Und.1.wee" ,  "Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon") )


```

Things look good.  Those fits are barely any worse than the unconstrained version, except in the middle, where (as expected) the fit isn't as good.  Those coefficients are:

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Positive Coefficients"}

coefs.f <- coefs.e %>% 
  bind_rows(coefs.m, coefs.l)

coefs.g <- coefs.f %>% 
  gather(type, value, -Component, -Estimate, -Weight, - days.vec, -stage)

coefs.g$Component <- factor(coefs.g$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.g$stage <- factor(coefs.g$stage, levels = c("early", "mid", "late"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = Estimate), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Coefficients for Departures to Indonesia in three decades")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())+
  facet_grid(.~stage)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.05))
```

This seems to still tell a sensible story.  Travel to Indonesia mostly consists of short trips, but there's been a noticeable increase in both very short, and quite long trips of late.  Let's multiply that by the right weights and durations to get the impact on travel in numbers we can understand.

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Indonesia Departures Positive Coefficients Weighted"}



coefs.g$Component <- factor(coefs$Component, levels = c("Num.of.mov.Und.1.wee","Num.of.mov.1.and.und.2.wee", "Num.of.mov.2.wee.and.und.1.mon",
"Num.of.mov.1.and.und.2.mon", "Num.of.mov.2.and.und.3.mon", "Num.of.mov.3.and.und.6.mon"    
, "Num.of.mov.6.and.und.12.mon"))

coefs.g$stage <- factor(coefs.g$stage, levels = c("early", "mid", "late"))

plot <- ggplot(data = coefs.g, aes(x = Component))+
  geom_bar(aes(y = value, fill = type), position = "dodge", stat = "identity")+
  theme(axis.text.x = element_text(size=8, angle=30))+
  labs(title = "Impact of Indonesia Departures by Component")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  theme(legend.title=element_blank())+
  facet_grid(.~stage)

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 80, b = 120, r = 70),
         legend = list(y = 0.95, x = 0.05))

```

Finally we have a result which we can put some more faith in.  Travel to Indonesia was dominated by quick trips when it was low in the 90s and 2000s.  Since 2010 the largest increase has also been in short trips, probably of 1-2 weeks duration.  However, it's likely that there's been a noticeable, and new component of longer trips.  Whilst substantially smaller in number, it's plausible that this shift towards longer-term visits accounts for even more absentees from Australia overall.  However, even combined, the growth in short term departures between the decades of the Noughties and the Teens could only account for about 50,000 people, around 5% of the Missing Million, and a negligible portion of the significant share that had grown in the years prior to 2010. 

##Conclusions
Even if we neglect entirely the unrealistically large component of longer departures (6-12 months) to New Zealand, in the post 2010 period it's plausible that New Zealand contributes nearly as many towards the Missing Million from journeys of just a few weeks duration.  Adding in at least the hint that longer visits are a significant component of journeys to New Zealand, it's almost certain that they comprise a larger share than visits to Bali.

However, perhaps the more important conclusion to draw is that only a trivial fraction of the Missing Million is accounted for by short-term visits to both Indonesia and New Zealand, and even all of the "Short Term" departures don't come close.  Other elements, including our long-term movements and short-term arrivals, are needed as well to understand what is going on.  The extent to which these series overlap or exclude one another is completely unclear.

Realistically, far more work has to be done to really understand the complex dynamics of Australia's population.  The statistics need a lot of work to shed substantial light, and grasping at the easiest available story is likely not sufficient.  ABS has recently decided to abandon the requirement for people to fill in departure cards, and doing so has actually caused another series break in 2007, which I've neglected to give any consideration to here. Apparently, the ABS is realising that the data collected on them wasn't adding up and isn't helping.

Overall I'm inclined to maintain what I've [previously claimed](https://www.quixoticquant.com/post/the-state-of-debate-a-bird-s-eye-on-migration/), that immigration data is one of the most falsely-revered 'clean' statistics in existence.  The hardest numbers we have still show [evidence of substantial](https://www.quixoticquant.com/post/the-missing-million/) discrepancies, enough to radically alter the policy conclusions we typlically draw from them.  The more detailed numbers we tend to reach to construct narratives to defend our use of them generally don't add up, or aren't consistently or comprehensively recorded enough to indicate anything at all with any confidence.  The best narrative to explain the Missing Million is the enormous increase in international mobility.  This, coupled with our peculiar economic, political, and overwhelmingly geographical circumstance has left us with a 'part-time population', and a frothy figure of 'residents' that is consistently and substantially higher than the number of people we physically have here at any given time.  The nature of this dynamic could benefit from further work, and I welcome any further critiques or contributions.

Q.Q.

The .Rmd file for this post can be accessed which will require the installation of this [package](https://github.com/aidandmorrison/UtilsQQ) to run. 