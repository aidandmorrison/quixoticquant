---
title: "The Missing Million Part II: Bringing the Boomers back from Bali"
author: Aidan
date: '2017-09-08'
slug: the-missing-million
thumbnail: "images/flatline2.png"
categories:   
  - Demographics
  - Economics
  - Migration
tags:
  - ABS
  - Census
  - Immigration
  - Statistics
  - Ausecon
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

##The Brawl Begins

This post is a follow-on from my [first post](http://www.quixoticquant.com/post/the-missing-million/) on this topic, where I suggested that an alternative statistic "Physicaly Present Population" suggested Australia's migration rate might be overstated by "Net Overseas Migration" and the derived "Estimated Resident Population".  I'm glad that the piece had the intended effect, and provoked two published responses from [Dr. Cameron Murray](http://www.fresheconomicthinking.com/2017/09/finding-australias-missing-million.html) and [Leith van Onselen](https://www.macrobusiness.com.au/2017/09/apparently-no-immigration-boom/). which I'll address in some detail later on.  I'm particularly flattered that Leith responded by re-pasting all four of the graphs from Dr Murray's so-called 'rebuke', five more of his own tired old favourites, but wasn't game to re-paste his darling NOM chart I'd focussed my attention on, nor a single one of the fourteen original plots which I'd produced directly from ABS data in the process.

But before posting the results of another deep dive in response, I thought keep the eyes on the horizon for a little to examine some broader context. It might help to clarify why I was keen to open my blog with an assault on the common usage of Net Overseas Migration (NOM), and why I'm happy to tilt just a little further.

The first perhaps is that I find myself unceasingly amazed by how little people understand data and it's sources.  Even if the professionals in planning and economic analysis who use it and create these graphs are aware of the nuance and subtelty that underlies it, the people that consumer their work undoubtedly aren't.  Last weekend the AFR's Jacob Greber [published](http://www.afr.com/news/economy/the-great-wage-squeeze--the-economy-picks-up-but-wage-growth-remains-at-a-low-20170825-gy3yg9) this un-speakably appalling abuse of data, apparently produced originally by the investment bank UBS:

```{r, fig.align="center", out.width = 500, fig.cap="The Australian Financial Review plumbs new depths in quality of data presentation"}


knitr::include_graphics("images/AFRGreberUBS.jpg")

```

Not only does this chart include Net Overseas Migration without the slightest acknowledgement of a definition change, but stacks it on-top of another entirely unrelated data series.  That data series is apparently of subset of one-way movements, (arrivals) and has no definition of length of stay whatsoever, which makes whatever it's presenting absolutely entirely uncomparable to Net Overseas Migration. Sure, just stack it up, see it reach 3% of population, and put 'Population Growth' in the heading.  No-one could possibly misinterpret that.  

For the record, here's the short term arrivals data, annualised, presented monthly:


As you'd expect education and employment are such a tiny fraction of short-term arrivals that they're really not worth considering on their own, they're completely swamped by other movements.  And because of the way our definitions work, (indicated intent on cards) there's nothing preventing a short-term movement becoming long-term, or remainging short term, and still becoming migration under the 12/16 rule, or vice-versa with long-term movements becoming short-term aswell.  Then there's the fact that all the short-term incoming movements inwards together are swamped by the all outgoing short-term movements, and possibly also swamped by the movements for these categories that are classified as long-term. (Though we don't have the data to know.)

Of course, if you zoom in on the relevant data-series and add up the numbers you'll see that you actually get a far higher number than the 500,000 in the article, as it turns out UBS has probably actually netted off departures aswell, which they make no mention of, nor do they mention that the levels in their graph is an annual movement, but reported as a trend quarterly. 

My point is, it's theoretically possible that UBS could have a sophisticated audience who wanted to answer an obscure question that this extremely irregular superposition of uncomparable, potentially overlapping, inconsistently recorded data might still provide the best available answer to.  If I was in the audience I'd still demand they tighten up their presentation (or at least label it right) so I could interpret it properly before I paid them anything for it. 

But if I wasn't a deep-diving data-junkie, and more of regular punter reading this sort of thing in the paper, I'd probably start freaking out about high migration, which looks like it's about to top 3% of population per annum.  That's not helpful.


Cameron Murray's conclusion, and the spin that Leith van Onselen puts on it, highlights true target of my charge:

>Overall, after a lot of thinking on this topic, I suspect that the ABS data, although imperfect, and although >hiding a series break, is probably the ‘better’ metric to use in planning and economic analysis.

Since when did economists start to economise on metrics to keep track of? It's ridiculous choose just one 'better' metric for a massive swathe of planning an anlysis.  Surely the cost of running another column in a spreadsheet isn't so high that we should deny ourselves an alternative metric that reveals new insights?  People write books about GDP and it's foibles, and people debate furiously about what it means, and doesn't.  But most would accept (sometimes grudgingly) different versions of it are useful for limited purposes.  For example growth in real GDP per capita is better mark of living standards improving than nominal GDP growth, which you might use to forecast income tax revenue.  

Why is that such a hard concept for people to grasp on population metrics? For allocating GST payments for health and education purposes, Estimated Resident Population, derived from NOM, might well be as good as it gets.  People who are away, but likely to be back, might need just as much health and education here in Australia.  But if you're trying to figure out how much gross revenue the GST is going to earn, you'd be stupid not to try to get a figure on what's happening to the Physically Present Population.  Being a million people out there is a substantial and preventable error, as it would be for a host of other factors.

The entire world of economics revolves around critiqueing and re-working hundreds of alternative metrics for all sorts of things, some tangible, some entirely abstract and continually changing, and debating which is the better to use, in which circumstance, to answer each particular policy or investment question. No serious economist takes the latest figures on any other topic without slinging in their share of accusations or probing questions, or at least breaking out a few component parts to figure out what other story might be hidden behind the headline.  Debate is vigorous, rowdy, and rolls on, like the clamour in a crowded bar.  And so it should be.

Except on migration.  On this single metric, it's as if the entire world converges into a deafeningly silent consensus.  Population!  At last a hard number. Something tangible, physical, consistent. The cacophony of economic debate subsides as everyone gather's around to pay homage at the alter of the purest, simplest driver of demand, production, and everything else.  The one undisputed back-stop to debate.

Bullshit. Perhaps once it was a hard and clean number, but today it isn't. It's about as arbitrary, inconsistent, ill-defined, confusing, volatile, politically sensitive, unpredictable, and hard-to-measure as any figure can be.  And not treating it like that is doing tremendous damage to debate.  Instead of absorbing information through the clamour of economic contention (think federal deficit, house prices, terms of trade) the public at large consumes the migration statistics the same way they consume Justin Bieber or Beyonce.  It just permeates the airwaves.  Australia has high migration.  Fan or not, it's there, and accepted, people let it roll over them, or bop along.

Until for whatever reason some over-enthusisastic fan-boy in the crowd tries to get everyone to get up and dance.  Enter Dick Smith, Macrobusiness, and many others. And here the debate around immigration enters the absurd. A group of otherwise well-meaning, capable, often intelligent people are quite vigorously running around promoting the following theorem:

>Lemma 1: Present Migration > Past Migration
>Lemma 2: Present Population < Future Population
>Therefore bad.
>Q.E.D.

They all know that linking rising population with actual bad outcomes is ambitious and complicated task in the extreme.  There are dozens alternative more powerful contributors to high house prices, city congestion, poor school performance, environmental degradation, and they all know it.  Pushing population to the top of the pile of explanations for those phenomena is a mammoth task.  Not even the Productivity Commission's 700 page report claimed to get close.  But the spruikers of the ponzi narrative get such tremendous momentum pointing authoritatively to the evidence backing Lemma 1 and Lemma 2 that they don't have to even seriously make the case. Somehow the logical leap is simply taken in their stride.  (Note, that doesn't make the opposite leap any easier, which many also attempt.)

Even worse is the reaction of some on the other side of the debate.  When confronted with seemingly irrefutable statistics being used to draw entirely unrelated conclusions, they just stammer for explantions, turn red, and start calling the other guys racist.  Or if they're in office just stammer some more, maybe try to say something politically correct and meaningless about the contribution of migrants, ageing, and hope the question goes away.  Everyone's stumped when trying to explain what appears to be a level-shift.  What underlies the change, and why is it justified?

So I'm delighted to find that my initial attack on NOM has got the kind of response that it did. I should point out I've got no interest in landing a knock-out punch to Net Overseas Migration, and having someone raise my fist and declare Physically Present Population the champion migration number.  I want to pick a fight to start a bar brawl, as economics seems to have raging (as it should) over essentially every other important metric.

Cameron Murray made a welcome foray, and dove further into additional data from 3401 to try to find a plausible explanation for the divergence I outlined in my first post.  He suggests that the missing million could substantially comprise Australian boomers in or approaching retirement taking holidays in Bali.  I'll address this in more detail in a later post, but finding insights like this is a perfect example of the need to explore components of the data.  If a million extra-bronzed baby-boomers finally drift back from Bali once they've spent their super to get sick and die in the comfort of the 4-bedroom homes in Australian suburbia while on the pension, that will create all sorts of pressures worth planning for.  Expelling a million of our young foreign students, backpackers, and skilled workers won't relieve any of them. 

And then there's Leith Van Onselen, the consumate DJ for the camp that's tapping toes to the Ponzi story (literally, check the comments), who quickly cranks out the old MB beat: cut, paste, curse, post.  He quote's every sentence of Murray's "rebuke" except the one where he call my work brilliant, as well as all four graphs. Then shouts back something like "What??!! Am I meant to believe it's not really this simple??!!" And cranks up the volume some more with yet another re-posting of the same clutch of monotonous, rising-red-line graphs we've seen a thousand times before from him.  Lemma 1, Lemma 2, thanks, I got it.

Yes Leith, that's exactly what I'm asking you to believe.  It's not that simple.  In economics it rarely is.  You can keep re-posting the same old graphs without any new analysis if you want.  But if you do it while shirking posting a single one of the 14 original graphs which supported my analysis, eventually people will figure that econ-bloggers don't stoop that low unless they've been hit where it hurts. Do what MB does so well on every other topic, and expose some complexity behind the superficial stats so people can get a clearer picture.  Maybe there's another important story that you're missing.

## The simple story everyone missed:
Trying to find a simple and defensible explanation of a complex issue isn't easy.  But for migration, I think there is one.  I'll describe it here in prose, and in a later post gather some of the graphs and data that support it.

There has been a level shift.  But it hasn't been in 'migration', as everyone actually intends and understands the word.  The shift that we should be talking about has been in mobility.  International travel is roaring ahead at 6-7% growth per annum, and in its wake we're left with a frothy migration figure, which might have risen to 0.8%. 

The total pace of movement of the world's population has accelerated.  Anecdotally people sense some pressure, and they're probably right to sense it.  But the true cause isn't that our system has been pumped full with more people.  The pressure actually comes from what one could think of as heat, the average pace of movement of all the people within and around the system.  The increasing scale and velocity of movements certainly causes pressure in various places as the accelerating flows converge, convulse and collide.  But to think of the main cause of this pressure as being an increasing accumulation of more people is to miss the bigger and more imporatant story.  You'll jump up and down about 1.5%, but miss the trend that's tracking closer to 6 or 7%.

And it's this tremendous uptick in mobility that gets distorted by the lense of migration defintions, and the peculiarities of our geographic and political circumstances, which bizarre and unique:  We're reasonably sized, rich, English-speaking Western country, the populated parts of which are still a full day's flight away from the arse-end of Asia. No-one else is like that.

This has important consequences for travel patterns.  In particular, we're a hard place to get to for a few days or a week or two, particularly for the rest of the Western World who might share our language.  However, for a couple of years we're definitely worth the journey.  As it happens we also have a lot on offer for couple-year type travellers: great place to back-pack around, excellent education opportunities, or cut your teeth in a new professional setting for a couple of years.

And what's in our neighbourhood?  Asia, NZ, and the Pacific.  Great if you want to have an adventure for a few weeks/months, enjoy other beaches, cheaper food, better skiing.  But most of Asia is still developing.  That also means there are business opportunities there, but living in Asia long-term means contending with other languages, less good schools, and possibly less good medical facilities or other infrastructure. 

In other words, Australia's a great place to come to for a couple of years, and a great place to leave from for a couple of weeks.  And that's what people do.  Students and backpackers alike treat Australia as something of a 'home-base' while they're here, but often visit other places in Asia, including for return visits home.  New Zealanders do the same, with hundreds of thousands of Kiwis coming here to work or study, and going home for regular visits.  Arrive long-term occasionally, leave short-term frequently, but be counted as 'resident' all the while. 

So here's the rub.  Whilst we (and perhaps the rest of the world) have accepted the definition 'resident' as being 'here more on average than elsewhere', defined over a 16-month period Australia is bound to measure artificially high rates of migration.  That's beause we count almost all of the inbound visitors as 'resident' in our country, but we count all of our outbound visitors a still 'resident' here aswell, even while they're away, which increasingly they are.  In that regime, as 'visiting' rises, in all directions, for all the world, if flows that substantially net out (or net out more than some figures suggest) that definition inevitably means that Australia will register an increasing number of 'residents'.  

Likewise a number of other countries might record artificially low 'migration', or negative migration, when their physically present populations remain bouyant.  Those countries would no-doubt include plenty of Asian countries, who's young middle-classes increasingly will spend a few years abroad to gain skills and experience in West (an increasing outflow of residents) but have their present populations butressed by hoards of short-term visitors enjoying exotic pleasures and cheaper currency on holidays, or making quick visits to set up business in new booming economies.  None of the inflows count as 'migration', but all the outflows do.

## A quaint analogy - the restaurant
I've battled trying to find an appropriate analogy to explain the concept.  The first that came to mind relate to different layers of quantum shells for electron orbits around different atoms embedded in somekind of semi-conductor exposed to a higher cross-current. But perhaps it's easier to think about a restaurant, like the one I have, which does both take-away coffees, beers at a bar, as well as dine-in table service food.  If you count number of people present at any moment, you'll have some ordering takeawy and waiting near the bar, or sipping a beer there, and some people sitting down with a menu getting table service.  But this hypothetically this restaurant only keeps count of 'patrons', which they might define as being just those people that sit down for table service and order food.

Imagine the locality suddenly gentrifies, and a whole host of new hipster cafe/bars open up in the area, foot traffic increases massively, but so does competition. This particular restaurant finds they can't compete with the funky baristas and bartenders down the street.  But they hold their own in the full-table-service dining, and the dinner menu takes off.  Two things happen simultaneously.  Suddenly the queue for coffee seems to disappear, as do plenty of drinkers that used to be perched at the bar, which is looking oddly empty.  The dinner trade booms, and changes at the same time.  More customers are coming for dinner, but they're staying for shorter periods, often getting an aperativ down the street instead of entre, and skipping desert and coffee in favour of another cafe down the street. Or some even slip-out between courses to get a cocktail or digestive elsewhere.

The business changes massively, and has to evolve and adapt to keep pace.  The peaks and troughs become more intense and unpredictable.  The movements in and out, changes in table arragements for different groups and couples become hard to manage.  It's a touch more noisy, and there's no doubt that things feel more 'busy', the business is still profitable, maybe slightly more, seemingly not in proportion to the increased pressure the staff are feeling.  But is it more 'full'? Well, that's complicated...  

Just a few regular customers don't like the change, one even posts a review online saying as much.  Then a cranky chef barges out of the kitchen one night and starts hurling abuse at the poor girl who's the hostess, accusing her of hopelessly over-booking the restaurant.  He pulls out a bunch of statistics showing how sharply the growth in 'patrons' (dine-in) has increased, extrapolates fourty years into the future and says it can't possibly be sustained, bellowing that there'll be rowdy crowds and fist-fights before long.  He then demonstrates that the spend-per-table has decreased, and enters a furious rant about how the company's profits are imperilled by the reckless over-booking of the hostess.  Every possible mistake and error that the restaurant has encountered is laid at the feet of over-booking hostess.  More broken glassware, to mistakes made in the kitchen, every bad review, the paint peeling on the walls, last week's weather, you name it. Over-booking caused it all.

The poor hostess is gobsmacked by the attack.  She stammers and stutters, trying to explain how walk-in have increased and people don't book any more, but still want to eat. But it all seems hopeless in the face of the hard-facts about rising patron numbers and diminished spend-per-head.  How to re-arrange the restaurant, use all the spare space around the bar, the loss of all the coffee trade, the idle bartenders, it all just seems too technical. Moreover, she hasn't looked at any hard numbers to prove the point, since the number of coffee and bar customers is recorded differently the 'patrons' that the chef is brandishing and she's not great at maths. She goes red in the face, calls the chef a bastard, and runs home to sulk, embarrassed that she swore at her colleague.

Such is the state of the migration debate in Australia.  We need to do better than that. 

Are Net Overseas Migration and Estimated Resident Population still useful, probably necessary numbers to keep track of?  Of course.

But are they sufficient? Far from it, and further every year.  Adding 'Total Net Movements' and 'Physically Present Population' would be an easy and good place to start.



That particular tilt certainly had the intended effect, and provoked quite a response.  I've had plenty of tweets, as well as direct emails and phone calls from people wanting to discuss with me the findings.  Two reactions in particular exceeded all my expectations.  The first was that a real accomplished economist immediately published a thoughtful response.  Please see [here](http://www.fresheconomicthinking.com/2017/09/finding-australias-missing-million.html) for Dr. Cameron Murray's excellent reply.  He used some data to suggest that much of the missing million was probably comprised of jet-setting boomers having holidays to places like Bali, for around a month or two at a time.  I'll reflect on that here in more detail.

But nothing could eclipse the compliment that Leith Van Onselen gave me in his rebuke on Macrobusiness.  I was glad to get a reply, and assumed that if I did get one it would along the lines of the regular MB forumla: cut, paste, curse, post. I didn't expect the cutting and pasting to be particularly kind to my argument.  But Leith took things to new levels by taking the time to copy and paste all four of the chart's from Cameron's response, five of his favourite (which MB followers will be familiar/bored with), and not a SINGLE one of the 14 original graphs from my post. You know you've landed a blow where it hurts when econ-bloggers start stooping that low.

Perhaps I should also take a moment to explain clearly that in my posts I'll often use [plotly](https://plot.ly/) graphs so that users can inspect the detail of the data behind the image, measure differences, exact numbers and dates, zoom in on areas of interest etc. If you hold your mouse over an image you'll also see a little button like a camera pop up, which allows you to download the plot as a png, so that anyone interested in re-posting my graphs can do so. (Acknowledgment would be appreciated.)




```{r get_data, include=FALSE}
library(tidyverse)
library(stringr)
library(gdata)
library(lubridate)
library(plotly)
library(UtilsQQ)
library(ggplot2)


sheet_310101 <- readxl::read_xls("data/310101.xls", sheet = 2)
sheet_310101 <- good_names(sheet = sheet_310101)
meta <- stash_meta(sheet_310101)
meta <- good_names(meta, meta = TRUE)
sheet_310101 <- cut_meta(sheet_310101)
sheet_310101 <- good_date(sheet_310101)
sheet_310101 <- to_numeric(sheet_310101)
sheet_310101 <- nom_units(sheet_310101, meta)
sheet_310101 <- inst_ann(sheet_310101, meta)
sheet_310101 <- prev_12_month(sheet_310101, meta)

sheet_340101 <- readxl::read_xls("data/340101.xls", sheet = 2)

sheet_340101 <- good_names(sheet = sheet_340101)
meta1 <- stash_meta(sheet_340101)
meta1 <- good_names(meta1, meta = TRUE)
meta <- bind_rows(meta, meta1)
sheet_340101 <- cut_meta(sheet_340101)
sheet_340101 <- good_date(sheet_340101)
sheet_340101 <- to_numeric(sheet_340101)
sheet_340101 <- nom_units(sheet_340101, meta)
sheet_340101 <- inst_ann(sheet_340101, meta)
sheet_340101 <- prev_12_month(sheet_340101, meta)

sheet_340102 <- readxl::read_xls("data/340102.xls", sheet = 2)

sheet_340102 <- good_names(sheet = sheet_340102)
meta2 <- stash_meta(sheet_340102)
meta2 <- good_names(meta2, meta = TRUE)
meta <- bind_rows(meta, meta2)
sheet_340102 <- cut_meta(sheet_340102)
sheet_340102 <- good_date(sheet_340102)
sheet_340102 <- to_numeric(sheet_340102)
sheet_340102 <- nom_units(sheet_340102, meta)
sheet_340102 <- inst_ann(sheet_340102, meta)
sheet_340102 <- prev_12_month(sheet_340102, meta)

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "Net Movement figures don't replicate Net Overseas Migration"}



sheet_310101 <- sheet_310101 %>% 
  mutate(NOM.12.12.Pre.12 = (case_when(Date < "2006-09-01 GMT" ~ Net.Ove.Mig.Aus.Pre.12m)),
         NOM.12.16.Pre.12 = (case_when(Date >= "2006-09-01 GMT" ~ Net.Ove.Mig.Aus.Pre.12m)))

sheet_arr_dep <- bind_cols(sheet_340101, sheet_340102)
sheet_arr_dep <- sheet_arr_dep %>% 
  mutate(net.movements = (Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep),
         net.per.long.term = (Num.of.mov.Per.and.Lon.ter.Arr - Num.of.mov.Per.and.Lon.ter.Dep),
         net.movements.Pre.12m = (Num.of.mov.Tot.Arr.Pre.12m - Num.of.mov.Tot.Dep.Pre.12m)
  )

match_sheet_arr_dep <- sheet_arr_dep %>% 
  filter(Date %in% sheet_310101$Date)

joint_sheet_310101 <- sheet_310101 %>% 
  inner_join(match_sheet_arr_dep, by = "Date")

joint_sheet_310101 <- joint_sheet_310101 %>% 
  mutate(Net.Ove.Mig.Aus.Pre.12m.per.ERP = (Net.Ove.Mig.Aus.Pre.12m/Est.Res.Pop.ERP.Aus),
         net.movements.Pre.12m.per.ERP = (net.movements.Pre.12m/Est.Res.Pop.ERP.Aus),
         cum.net.movements = cumsum(net.movements.Pre.12m/4),
         cum.Net.Ove.Mig.Aus = cumsum(Net.Ove.Mig.Aus),
         cum.discrepancy = cum.Net.Ove.Mig.Aus - cum.net.movements,
         Phy.Pre.Pop.PPP.Aus = Est.Res.Pop.ERP.Aus - cum.discrepancy,
         Net.Ove.Mig.Aus.Pre.12m.per.PPP = Net.Ove.Mig.Aus.Pre.12m/Phy.Pre.Pop.PPP.Aus,
         net.movements.Pre.12m.per.PPP = net.movements.Pre.12m/Phy.Pre.Pop.PPP.Aus
  )

plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  # geom_line(aes(y = Num.of.mov.Per.and.Lon.ter.Dep.Pre.12m, col = "Perm and Long Term Dep"))+
  # geom_line(aes(y = Num.of.mov.Per.and.Lon.ter.Arr.Pre.12m, col = "Perm and Long Term Arr")) +
  geom_line(aes(y = (Num.of.mov.Sho.ter.les.tha.one.yea.Res.ret.Pre.12m -
                       Num.of.mov.Sho.ter.les.tha.one.yea.Res.dep.Pre.12m +
                       Num.of.mov.Sho.ter.les.tha.one.yea.Vis.arr.Pre.12m -
                       Num.of.mov.Sho.ter.les.tha.one.yea.Vis.dep.Pre.12m), col = "Net Short Term Movements"), size = 0.8)+
  geom_line(aes(y = Net.Ove.Mig.Aus.Pre.12m, col = "Net Overseas Migration"), size = 0.8)+
  geom_line(aes(y = Num.of.mov.Per.and.Lon.ter.Arr.Pre.12m - Num.of.mov.Per.and.Lon.ter.Dep.Pre.12m, col = "Net Permanent and Long Term"), size = 0.8)+
  scale_colour_manual("", 
                      breaks = c("Net Short Term Movements", "Net Overseas Migration", "Net Permanent and Long Term"),
                      values = c("red", "black", "green"))+
  labs(title = "Net Overseas Migration with Net Short and Long Term Movements")+
  scale_y_continuous(labels = scales::comma, limits = c(-300000, 460000)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 60),
         legend = list(x = 0.01, y = 0.99))


```



```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking"}

plot <- sheet_arr_dep %>% 
  filter(Date > "2009-12-02 GMT") %>% 
  ggplot(aes(x = Date))+
  geom_line(aes(y = cumsum(Num.of.mov.Tot.Dep), col = "Dep"))+
  geom_line(aes(y = cumsum(Num.of.mov.Tot.Arr), col = "Arr"))+
  labs(title = "Cumulative Arr and Dep")

ggplotly(plot)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking2"}

plot <- sheet_arr_dep %>% 
  filter(Date > "2009-12-02 GMT") %>% 
  ggplot(aes(x = Date))+
  geom_line(aes(y = Num.of.mov.Tot.Dep, col = "Dep"))+
  geom_line(aes(y = Num.of.mov.Tot.Arr, col = "Arr"))+
  labs(title = "Exact Arr and Dep")

ggplotly(plot)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}

sheet_arr_dep <- sheet_arr_dep %>% 
  mutate(month = month(Date), year = year(Date))

sheet_arr_dep <- sheet_arr_dep %>% 
  mutate(index = row_number())

sheet_arr_dep <- sheet_arr_dep %>% 
  group_by(year) %>% 
  mutate(year.cum = cumsum(net.movements),
         jan.flow = case_when(month == 1 ~ net.movements),
         year.flow = case_when(month == 12 ~ year.cum))

sheet_arr_dep <- sheet_arr_dep %>% 
  fill(jan.flow)

sheet_arr_dep <- sheet_arr_dep %>% 
  ungroup() %>% 
  mutate(cum.net.movements = cumsum(net.movements))

sheet_arr_dep_dec <- sheet_arr_dep %>% 
  filter(month == 12)

sheet_arr_dep_dec <- sheet_arr_dep_dec %>% 
  mutate(year.cum = 0)

sheet_arr_dep_13m <- sheet_arr_dep %>% 
  bind_rows(sheet_arr_dep_dec) %>% 
  arrange(index)

sheet_arr_dep_13m <- sheet_arr_dep_13m %>% 
  mutate(lag.month = lag(month,1)) %>% 
  filter(index > 1)
         
sheet_arr_dep_13m <- sheet_arr_dep_13m %>% 
  mutate(new.month = case_when(
           month == lag.month ~ 0,
           month != lag.month ~ month),
         new.year = case_when(
           month == lag.month ~ year + 1,
           month != lag.month ~year))

sheet_arr_dep_13m <- sheet_arr_dep_13m %>% 
  fill(year.flow)

plot <- sheet_arr_dep %>% 
  filter(Date > "2009-12-02 GMT") %>% 
  ggplot(aes(x = month))+
  geom_line(aes(y = Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep, col = year))+
  labs(title = "Net Arr and Dep")

ggplotly(plot)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}


plot <- sheet_arr_dep %>% 
  filter(Date > "1999-12-02 GMT", Date <= "2010-01-02 GMT") %>% 
  ggplot(aes(x = as.numeric(month), y = Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep, group = as.factor(year), col = year))+
  geom_line()+
  #stat_smooth(method = 'lm', formula = y ~ poly(x,6),  se= FALSE)+
  labs(title = "Net Arr and Dep")

ggplotly(plot)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}


plot <- sheet_arr_dep_13m %>% 
  filter(new.year >= 2010) %>% 
  ggplot(aes(x = new.month))+
  geom_line(aes(y = year.cum, col = as.factor(new.year)))+
  labs(title = "Cumulative Arr and Dep")

ggplotly(plot)

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}


plot <- sheet_arr_dep_13m %>% 
  filter(new.year >= 2010) %>% 
  ggplot(aes(x = new.month))+
  geom_line(aes(y = cum.net.movements - (head(cum.net.movements, n = 1)), col = as.factor(new.year)))+
  labs(title = "Cumulative Arr and Dep")

ggplotly(plot)

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}


plot <- sheet_arr_dep_13m %>% 
  filter(new.year >= 2000, new.year <= 2009) %>% 
  ggplot(aes(x = new.month))+
  geom_line(aes(y = cum.net.movements - (head(cum.net.movements, n = 1)), col = as.factor(new.year)))+
  labs(title = "Cumulative Arr and Dep")

ggplotly(plot)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Checking3"}

plot <- sheet_arr_dep %>% 
  filter(Date > "2009-12-02 GMT") %>% 
  ggplot(aes(x = Date, y = cumsum(net.movements), col = as.factor(year)))+
  geom_line()+
  stat_smooth(method = 'lm', formula = y ~ poly(x,1), se= FALSE, colour = "black")+
  labs(title = "Cumulative Net Movements")

ggplotly(plot)

```



```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

sheet_340106 <- readxl::read_xls("data/340106.xls", sheet = 2)

sheet_340106 <- good_names(sheet = sheet_340106)
meta3 <- stash_meta(sheet_340106)
meta3 <- good_names(meta3, meta = TRUE)
meta <- bind_rows(meta, meta3)
sheet_340106 <- cut_meta(sheet_340106)
sheet_340106 <- good_date(sheet_340106)
sheet_340106 <- to_numeric(sheet_340106)
sheet_340106 <- nom_units(sheet_340106, meta)
sheet_340106 <- inst_ann(sheet_340106, meta)
sheet_340106 <- prev_12_month(sheet_340106, meta)


plot <- sheet_340106 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Und.1.wee, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon, col = "6 to 12 months"))+
  
  labs(title = "Short Term Movements Arrivals")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```



```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

plot <- sheet_340106 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Con, col = "Conferences"))+
  geom_line(aes(y = Num.of.mov.Hol, col = "Holidays"))+
  geom_line(aes(y = Num.of.mov.Bus, col = "Business"))+
  geom_line(aes(y = Num.of.mov.Emp, col = "Employment"))+
  geom_line(aes(y = Num.of.mov.Edu, col = "Education"))+
  geom_line(aes(y = Num.of.mov.Vis.fri, col = "Visit Friends"))+
  
  labs(title = "Short Term Movements Arrivals")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

sheet_3401010 <- readxl::read_xls("data/3401010.xls", sheet = 2)

sheet_3401010 <- good_names(sheet = sheet_3401010)
meta4 <- stash_meta(sheet_3401010)
meta4 <- good_names(meta4, meta = TRUE)
meta <- bind_rows(meta, meta4)
sheet_3401010 <- cut_meta(sheet_3401010)
sheet_3401010 <- good_date(sheet_3401010)
sheet_3401010 <- to_numeric(sheet_3401010)
sheet_3401010 <- nom_units(sheet_3401010, meta)
sheet_3401010 <- inst_ann(sheet_3401010, meta4)
sheet_3401010 <- prev_12_month(sheet_3401010, meta4)


plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Und.1.wee, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon, col = "6 to 12 months"))+
  labs(title = "Short Term Movements Resident Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Movements out annual"}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m, col = "6 to 12 months"))+
  labs(title = "Short Term Movements Resident Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```




```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Movements out impact"}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.2.wee.and.und.1.mon.Pre.12m*22/365, col = "2 weeks to a month"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.wee.Pre.12m*11/365, col = "1 to 2 weeks"))+
  geom_line(aes(y = Num.of.mov.Und.1.wee.Pre.12m*4/365, col = "under 1 week"))+
  geom_line(aes(y = Num.of.mov.1.and.und.2.mon.Pre.12m*46/365, col = "1 to 2 months"))+
  geom_line(aes(y = Num.of.mov.2.and.und.3.mon.Pre.12m*77/365, col = "2 to 3 months"))+
  geom_line(aes(y = Num.of.mov.3.and.und.6.mon.Pre.12m*165/365, col = "3 to 6 months"))+
  geom_line(aes(y = Num.of.mov.6.and.und.12.mon.Pre.12m*273/365, col = "6 to 12 months"))+
  labs(title = "Short Term Movements Resident Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

plot <- sheet_3401010 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Con, col = "Conferences"))+
  geom_line(aes(y = Num.of.mov.Hol, col = "Holidays"))+
  geom_line(aes(y = Num.of.mov.Bus, col = "Business"))+
  geom_line(aes(y = Num.of.mov.Emp, col = "Employment"))+
  geom_line(aes(y = Num.of.mov.Edu, col = "Education"))+
  geom_line(aes(y = Num.of.mov.Vis.fri, col = "Visit Friends"))+
  
  labs(title = "Short Term Movements Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```



```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}

sheet_340109 <- readxl::read_xls("data/340109.xls", sheet = 2)

sheet_340109 <- good_names(sheet = sheet_340109, trunc_length = 4)
meta5 <- stash_meta(sheet_340109)
meta5 <- good_names(meta5, meta = TRUE, trunc_length = 4)
meta <- bind_rows(meta, meta5)
sheet_340109 <- cut_meta(sheet_340109)
sheet_340109 <- good_date(sheet_340109)
sheet_340109 <- to_numeric(sheet_340109)
sheet_340109 <- nom_units(sheet_340109, meta5)
sheet_340109 <- inst_ann(sheet_340109, meta5)
sheet_340109 <- prev_12_month(sheet_340109, meta5)

topcountries <- sheet_340109 %>% 
  filter(Date > "2014-01-01 GMT") %>% 
  select(Numb.of.move.Norf.Isla:Numb.of.move.Tota.Coun.of.stay) %>% 
  gather(country, movements, Numb.of.move.Norf.Isla:Numb.of.move.Tota.Coun.of.stay)
  
topcountriessum <- topcountries %>% 
  group_by(country) %>% 
  summarise(ave_mov = mean(movements)) %>% 
  arrange(ave_mov, desc(ave_mov)) %>% 
  filter(str_detect(country, ".Tota.") == FALSE) %>% 
  tail(n = 15)

topregionssum <- topcountries %>% 
  group_by(country) %>% 
  summarise(ave_mov = mean(movements)) %>% 
  arrange(ave_mov, desc(ave_mov)) %>% 
  filter(str_detect(country, ".Tota.") == TRUE) %>% 
  tail(n = 10)

plot <- sheet_340109 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col = "NZ"))+
  geom_line(aes(y = Numb.of.move.Indo, col = "Indonesia"))+
  geom_line(aes(y = Numb.of.move.Unit.Stat.of.Amer, col = "USA"))+
  geom_line(aes(y = Numb.of.move.UK.CIs.IOM, col = "UK"))+
  geom_line(aes(y = Numb.of.move.Thai, col = "Thailand"))+
  geom_line(aes(y = Numb.of.move.Chin, col = "China"))+
  geom_line(aes(y = Numb.of.move.Sing, col = "Singapore"))+
  geom_line(aes(y = Numb.of.move.Fiji, col = "Fiji"))+
  geom_line(aes(y = Numb.of.move.Japa, col = "Japan"))+
  
  labs(title = "Short Term Movements Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="New Graph of Movements"}


plot <- sheet_340109 %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.East.Asia, col = "SE Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Ocea.and.Anta, col = "Oceana"))+
  geom_line(aes(y = Numb.of.move.Tota.Amer, col = "America"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.East.Asia, col = "NE Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.West.Euro, col = "NW Europe"))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.and.East.Euro, col = "SE Europe"))+
  geom_line(aes(y = Numb.of.move.Tota.Sout.and.Cent.Asia, col = "Sourth Cent Asia"))+
  geom_line(aes(y = Numb.of.move.Tota.Nort.Afri.and.the.Midd.East, col = "North Africa Middle East"))+
  geom_line(aes(y = Numb.of.move.Tota.Sub.Saha.Afri, col = "Sub Saharan Africa"))+
  
  labs(title = "Short Term Movements Departures")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NOM Breakdown"}

sheet_NOM <- readxl::read_xls("data/NOM_by_visa.xls", sheet = 1)
sheet_NOM <- t(sheet_NOM) %>%  
  as_tibble()
#sheet_NOM <-data.frame(sheet_NOM) %>% as_tibble()
rownames(sheet_NOM) <- NULL
sheet_NOM <- sheet_NOM[-1,]

dates <- c("2007-06-30", "2008-06-30", "2009-06-30", "2010-06-30",
           "2011-06-30", "2012-06-30", "2013-06-30", "2014-06-30",
           "2015-06-30") %>% ymd() %>% as.numeric()

dates_vec <- tibble(dates)

sheet_NOM <- bind_cols(sheet_NOM, dates_vec)
sheet_NOM <- select(sheet_NOM, dates, everything())
colnames(sheet_NOM) <- c("Date", "Student", "Subclass 457", "Working Holiday", "Visitor", 
                         "Other Temp.", "Skilled", "Family", "Humanitarian",
                         "Other Perm.", "Aus Citizen", "NZ Citizen", "Other Visas")

sheet_NOM <- sheet_NOM %>% 
  good_names() %>% 
  good_date(Origin = "1970-01-01") %>% 
  to_numeric() %>% 
  nom_units(meta = meta, manual = "000")

sheet_NOM <- sheet_NOM %>% 
  mutate(Tot.Temp = (Stu + Sub.457 + Wor.Hol + Vis + Oth.Tem),
         Tot.Perm = (Ski + Fam + Hum + Oth.Per),
         Tot.Oth = (Aus.Cit + NZ.Cit + Oth.Vis))

sheet_NOM_long <- sheet_NOM %>% 
  gather(key = "Visa.cat", value = "flow", -Date)

sheet_NOM_long <- sheet_NOM_long %>% 
  mutate(Type = case_when(Visa.cat %in% c("Stu", "Sub.457", "Wor.Hol", "Vis","Oth.Tem") ~ "Temporary",
                          Visa.cat %in% c("Ski", "Fam", "Hum", "Oth.Per") ~ "Permanent",
                          Visa.cat %in% c("Aus.Cit", "NZ.Cit", "Oth.Vis") ~ "Other",
                          Visa.cat %in% c("Tot.Temp", "Tot.Perm", "Tot.Oth") ~ "Totals"))
    
    
    
pre_plot <- sheet_NOM_long %>% 
  filter(str_detect(Visa.cat, "Tot.") == FALSE) %>% 
  arrange(Type)

lvls <- unique(pre_plot$Visa.cat)


 plot<- pre_plot %>% 
    mutate(Visa.cat = factor(Visa.cat, levels = lvls)) %>% 
   ggplot(aes(x = Date, text = as_date(Date), y = flow, fill = Visa.cat, colour = Type))+
    geom_bar(position = "stack", stat = "identity")+
   scale_colour_manual("",
                      breaks = c("Temporary", "Permanent", "Other"),
                      values = c("grey", "black", "white"))


ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="NOM Breakdown By Category"}

plot <- sheet_NOM_long %>% 
  filter(str_detect(Visa.cat, "Tot.") == TRUE) %>% 
  ggplot(aes(x = Date, text = as_date(Date), y = flow, fill = Visa.cat))+
  geom_bar(position = "stack", stat = "identity")


ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```


```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "Calcs on Census"}

nat.growth.count.sheet <- sheet_310101 %>% 
  filter(Date > "2011-08-31 GMT") %>% 
  filter(Date < "2016-08-31 GMT") 

nat.growth.count <- sum(nat.growth.count.sheet$Nat.Inc.Aus)

net.mov.count.sheet <- sheet_arr_dep %>% 
  filter(Date > "2011-08-31 GMT") %>% 
  filter(Date < "2016-08-31 GMT") 

net.mov.count <- sum(net.mov.count.sheet$net.movements)

growth.ppp <- net.mov.count + nat.growth.count

nat.growth.count.sheet2 <- sheet_310101 %>% 
  filter(Date > "2006-08-31 GMT") %>% 
  filter(Date < "2011-08-31 GMT") 

nat.growth.count2 <- sum(nat.growth.count.sheet2$Nat.Inc.Aus)

net.mov.count.sheet2 <- sheet_arr_dep %>% 
  filter(Date > "2006-08-31 GMT") %>% 
  filter(Date < "2011-08-31 GMT") 

net.mov.count2 <- sum(net.mov.count.sheet2$net.movements)

growth.ppp2 <- net.mov.count2 + nat.growth.count2

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis"}
kiwis <- sheet_340109 %>% 
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor <- inner_join(sheet_3401010, kiwis, by = "Date")
kiwi_regressor <- select(kiwi_regressor, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor <- kiwi_regressor %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)

mod <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor)  # Regress y on everything (but Year)
summary(mod)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Kiwis"}
kiwis <- sheet_340109 %>% 
  select(Date, Numb.of.move.New.Zeal)
kiwi_regressor <- inner_join(sheet_3401010, kiwis, by = "Date")
kiwi_regressor <- select(kiwi_regressor, Date, Numb.of.move.New.Zeal,  everything ())
kiwi_length_regressor <- kiwi_regressor %>% 
  select(Date, Numb.of.move.New.Zeal, Num.of.mov.Con:Num.of.mov.Oth.not.sta)

mod <- lm(Numb.of.move.New.Zeal ~ . - Date, data = kiwi_length_regressor)  # Regress y on everything (but Year)
summary(mod)

model <- tibble(fit =mod$fitted.values)
  


model <- bind_cols(model, kiwi_length_regressor %>% select(Date, Numb.of.move.New.Zeal ))

plot <- ggplot(model, aes(x = Date))+
  geom_line(aes(y = Numb.of.move.New.Zeal, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

#plot(mod)

```

```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Poms"}
poms <- sheet_340109 %>% 
  select(Date, Numb.of.move.UK.CIs.IOM)
poms_regressor <- inner_join(sheet_3401010, poms, by = "Date")
poms_regressor <- select(poms_regressor, Date, Numb.of.move.UK.CIs.IOM,  everything ())
poms_length_regressor <- poms_regressor %>% 
  select(Date, Numb.of.move.UK.CIs.IOM, Num.of.mov.Con:Num.of.mov.Oth.not.sta)

mod <- lm(Numb.of.move.UK.CIs.IOM ~ . - Date, data = poms_length_regressor)  # Regress y on everything (but Year)
summary(mod)

```


```{r, warning=FALSE, message= FALSE, fig.align="center", fig.cap="Multivariat Regression of Indo"}
balis <- sheet_340109 %>% 
  select(Date, Numb.of.move.Indo)
bali_regressor <- inner_join(sheet_3401010, balis, by = "Date")
bali_regressor <- select(bali_regressor, Date, Numb.of.move.Indo,  everything ())
bali_length_regressor <- bali_regressor %>% 
  select(Date:Num.of.mov.6.and.und.12.mon)

mod <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor)  # Regress y on everything (but Year)
summary(mod)


mod <- lm(Numb.of.move.Indo ~ . - Date, data = bali_length_regressor)  # Regress y on everything (but Year)
summary(mod)

model <- tibble(fit =mod$fitted.values)
  


model <- bind_cols(model, bali_length_regressor %>% select(Date, Numb.of.move.Indo ))

plot <- ggplot(model, aes(x = Date))+
  geom_line(aes(y = Numb.of.move.Indo, col ="Original"))+
  geom_line(aes(y = fit, col = "Fitted"))

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The bare minimum to accurately represent a series break"}

datevec <- sheet_340101 %>% 
  filter(Date < "2006-09-01 GMT")%>% 
  select(Date)

date_change <- length(datevec$Date) +1

plot <- ggplot(sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = NOM.12.12.Pre.12, col = "12/12 Rule Definition of NOM"), size = .8)+
  geom_line(aes(y = NOM.12.16.Pre.12, col = "12/16 Rule Definition of NOM"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("12/12 Rule Definition of NOM", "12/16 Rule Definition of NOM"),
                      values = c( "red", "magenta1"))+
  geom_vline(xintercept = as.numeric(sheet_340101$Date[date_change]), linetype = 4, size = .8) +
  geom_text(x = as.numeric(sheet_340101$Date[date_change - 60]), y = 300000, label =  "Break in 
            Methodology", size =4)+
  labs(title = "Net Overseas Migration (NOM)") +
  ylab("asd")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 100, r = 100),
         legend = list(orientation = 'h',
                       y = -0.2, x = 0.1))

```





```{r, fig.align="center", out.width = 600, fig.cap="ABS excerpt published in Business Insider, 2017"}


knitr::include_graphics("images/ABS-population-increase.jpg")

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The exponential growth in monthly overseas movements"}


sheet_arr_dep <- bind_cols(sheet_340101, sheet_340102)
sheet_arr_dep <- sheet_arr_dep %>% 
  mutate(net.movements = (Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep),
         net.per.long.term = (Num.of.mov.Per.and.Lon.ter.Arr - Num.of.mov.Per.and.Lon.ter.Dep),
         net.movements.Pre.12m = (Num.of.mov.Tot.Arr.Pre.12m - Num.of.mov.Tot.Dep.Pre.12m)
  )

plot <- ggplot(sheet_arr_dep, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Tot.Arr, colour = "Total Arrivals Monthly" ))+
  geom_line(aes(y = Num.of.mov.Tot.Dep, colour = "Total Departures Monthly"))+
  scale_colour_manual("",
                      breaks = c("Total Arrivals Monthly", "Total Departures Monthly"),
                      values = c("green", "orange"))+
  labs(title = "All Arrivals and Departures Monthly")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 100),
         legend = list(y = 0.9, x = 0.1))

```


```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The increasing volatility of net monthly overseas movements"}


plot <- ggplot(sheet_arr_dep, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Num.of.mov.Tot.Arr - Num.of.mov.Tot.Dep ))+
  labs(title = "Net Monthly Movements (Positive is net Arrivals)")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 100))

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The link between NOM and Movements was clearly broken by 2006"}


plot <- joint_sheet_310101 %>% 
  filter(Date < "2006-06-02 GMT") %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
  geom_col(aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6)+
  geom_line(aes(y = Net.Ove.Mig.Aus.Pre.12m, colour = "Net Overseas Migration (NOM)"), size = .8)+
  geom_line(aes(x = Date, y = net.movements.Pre.12m, colour = "Net Overseas Movements"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("Cumulative Discrepancy", "Net Overseas Migration", "Net Overseas Movements"),
                      values = c("grey", "red", "blue"))+
  labs(title = "Net Movements vs NOM, with cumulative difference")+
  scale_y_continuous("Number")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 50),
         legend = list(y = 0.98, x = 0.4))


```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The gap between NOM and Movements widens after the definition change and the GFC"}

plot <- joint_sheet_310101 %>% 
  #filter(Date < "2006-06-02 GMT") %>% 
  ggplot(aes(x = Date, text = as_date(Date)))+
    geom_rect(xmin = as.numeric(as.POSIXct(as_date("2009-12-01 GMT"))), 
              xmax = as.numeric(as.POSIXct(as_date("2016-06-01 GMT"))), 
            ymin = 100000, ymax = 200000,
            fill = "yellow", alpha = 0.1)+
  geom_line(aes(y = NOM.12.12.Pre.12, col = "NOM 12/12 Definition"), size = .8)+
  geom_line(aes(y = NOM.12.16.Pre.12, col = "NOM 12/16 Definition"), size = .8)+
  geom_line(aes(y = net.movements.Pre.12m, col = "Net Movements"), size =.8)+
  scale_colour_manual("", 
                      breaks = c("12/12 Rule Definition of NOM", "12/16 Rule Definition of NOM", "Net Movements"),
                      values = c( "blue", "red",  "magenta1"))+
  labs(title = "Net Movements vs Net Overseas Migration")+
  geom_vline(xintercept = as.numeric(sheet_340101$Date[date_change]), linetype = 4) +
  scale_y_continuous("Number")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 100),
         legend = list(y = 0.95, x = 0.3))


```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "International travel slows during the GFC, even more for departures"}


plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_rect(xmin = as.numeric(as.POSIXct(as_date("2008-09-05 GMT"))), 
            xmax = as.numeric(as.POSIXct(as_date("2009-09-01 GMT"))), 
            ymin = 350000, ymax = 20000000,
            fill = "brown", alpha = 0.05)+
  geom_line(aes(y = Num.of.mov.Tot.Arr.Pre.12m, colour = "Total Arrivals 12 Months" ))+
  geom_line(aes(y = Num.of.mov.Tot.Dep.Pre.12m, colour = "Total Departures 12 Months"))+
  geom_col(aes(x = Date, y = net.movements.Pre.12m, colour = "Net Movements 12 Months"), fill = "grey", alpha = 0.6)+
  scale_colour_manual("",
                      breaks = c("Total Arrivals 12 Months", "Total Departures 12 Months", "Net Movements 12 Months"),
                      values = c("black", "green", "orange"))+
  geom_text(x = as.numeric(sheet_340101$Date[date_change + 5]), y = 5000000, label =  "AUD below 
            0.85 USD", size =3)+
  labs(title = "All Arrivals and Departures")+
  scale_y_continuous("Monthly Movements")+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 100),
         legend = list(y = 0.9, x = 0.1))

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The official NOM figure shows long-term acceleration of inward migration"}
plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date), y = Net.Ove.Mig.Aus.Pre.12m.per.ERP))+
  geom_line(size = 1, col = "black")+
  stat_smooth(method = 'lm', formula = y ~ poly(x,14), colour = "grey60", se= TRUE)+
  stat_smooth(method = 'lm', formula = y ~ poly(x,1), se= FALSE, colour = "red")+
  labs(title = "Net Overseas Migration as Rate, Trends Fitted")+
  scale_y_continuous("Growth Rate")+
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))


```


```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The figures on total Movements shows no long-term trend"}
plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date), y = net.movements.Pre.12m.per.PPP))+
  geom_line(size = 1, col = "black")+
  stat_smooth(method = 'lm', formula = y ~ poly(x,14), colour = "grey60", se= TRUE)+
  stat_smooth(method = 'lm', formula = y ~ poly(x,1), se= FALSE, colour = "blue")+
  labs(title = "Net Overseas Movements as Rate, Trends Fitted")+
  scale_y_continuous("Growth Rate")+
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70))


```


```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The cumulative discrepancy between official NOM and the population actually in Australia has exploded"}

plot <-ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_col(aes(x = Date, y = cum.discrepancy, colour = "Cumulative Discrepancy"), fill = "grey", alpha = 0.6)+
  geom_line(aes(y = NOM.12.12.Pre.12, col = "NOM 12/12 Definition"), size = .8)+
  geom_line(aes(y = NOM.12.16.Pre.12, col = "NOM 12/16 Definition"), size = .8)+
  geom_line(aes(x = Date, y = net.movements.Pre.12m, colour = "Net Overseas Movements"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("Cumulative Discrepancy", "Net Overseas Migration", "Net Overseas Movements"),
                      values = c("grey30", "blue", "red", "magenta1" ))+
  labs(title = "Net Overseas Migration vs Net Movements, and Cumulative Discrepancy")+
  geom_vline(xintercept = as.numeric(sheet_340101$Date[date_change]), linetype = 4, size = 0.4) +
  scale_y_continuous("Number")+
  geom_text(x = as.numeric(sheet_340101$Date[date_change - 40]), y = 750000, label =  "Break in 
            Methodology", size =3)+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 70),
         legend = list(y = 0.9, x = 0.1))

```




```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "Natural growth actually comprises over half of our population growth"}

plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Nat.Inc.Aus.Pre.12m, col = "Natural Increase Prev 12 Months"), size = .8)+
  geom_line(aes(y = net.movements.Pre.12m, col = "Net Movements Prev 12 Months"), size = .8)+
  #geom_line(aes(y = Net.Ove.Mig.Aus.Pre.12m, col = "Net Overseas Migration Prev 12 Months"), size = .8)+
  #geom_line(aes(y = Net.Ove.Mig.Aus.Pre.12m + Nat.Inc.Aus.Pre.12m, col = "Increase in Estimated Resident Population Prev 12 Months"), size = .8)+
  geom_line(aes(y = net.movements.Pre.12m + Nat.Inc.Aus.Pre.12m, col = "Increase in PPP Prev 12 Months"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("Natural Increase Prev 12 Months", "Net Movements Prev 12 Months", "Increase in PPP Prev 12 Months"),
                      values = c("black", "green", "blue"))+
  labs(title = "Annual Change in Physically Present Population (PPP) 
       by Component, and Combined")+
  scale_y_continuous("Number")+
  scale_y_continuous(labels = scales::comma, limits = c(-30000, 600000)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 70),
         legend = list(y = 0.95, x = 0.2))
  
```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The assumption that migration drives population growth arises from arbitrary, inconsistent definitions of Net Overseas Migration"}

plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = Nat.Inc.Aus.Pre.12m, col = "Natural Increase Prev 12 Months"), size = .8)+
  #geom_line(aes(y = net.movements.Pre.12m, col = "Net Movements Prev 12 Months"), size = .8)+
  geom_line(aes(y = NOM.12.12.Pre.12, col = "Net Overseas Migration 12/12"), size = .8)+
  geom_line(aes(y = NOM.12.16.Pre.12, col = "Net Overseas Migration 12/16"), size = .8)+
  geom_line(aes(y = Net.Ove.Mig.Aus.Pre.12m + Nat.Inc.Aus.Pre.12m, col = "Increase in ERP Prev 12 Months"), size = .8)+
  #geom_line(aes(y = net.movements.Pre.12m + Nat.Inc.Aus.Pre.12m, col = "Increase in Physically Present Population Prev 12 Months"), size = .8)+
  scale_colour_manual("", 
                      breaks = c("Natural Increase Prev 12 Months", "Net Overseas Migration 12/12","Net Overseas Migration 12/16", "Increase in ERP Prev 12 Months"),
                      values = c("black", "green", "red", "magenta"))+
  labs(title = "Annual Change in Estimated Resident Population (ERP) 
       by Component, and Combined")+
  scale_y_continuous(labels = scales::comma, limits = c(-30000, 600000)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 70, r = 70),
         legend = list(y = 0.95, x = 0.1))
  

```


```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "The population growth rate may actually have fallen since 2000"}
joint_21st <- joint_sheet_310101 %>% 
  filter(Date >= "2000-01-01 GMT") 

joint_20th <- joint_sheet_310101 %>% 
  filter(Date < "2000-01-01 GMT", Date >= "1982-03-01 GMT") 

modPPPrate <- mean((joint_21st$net.movements.Pre.12m+ joint_21st$Nat.Inc.Aus.Pre.12m)/joint_21st$Phy.Pre.Pop.PPP.Aus)
modERPrate <- mean((joint_21st$Net.Ove.Mig.Aus.Pre.12m + joint_21st$Nat.Inc.Aus.Pre.12m)/joint_21st$Est.Res.Pop.ERP.Aus)

oldPPPrate <- mean((joint_20th$net.movements.Pre.12m+ joint_20th$Nat.Inc.Aus.Pre.12m)/joint_20th$Phy.Pre.Pop.PPP.Aus)
oldERPrate <- mean((joint_20th$Net.Ove.Mig.Aus.Pre.12m + joint_20th$Nat.Inc.Aus.Pre.12m)/joint_20th$Est.Res.Pop.ERP.Aus)

joint_sheet_310101 <- joint_sheet_310101 %>% 
  mutate(mod.PPP.rate = case_when(Date >= "2000-01-01 GMT" ~ modPPPrate)) %>% 
  mutate(mod.ERP.rate = case_when(Date >= "2000-01-01 GMT" ~ modERPrate)) %>% 
  mutate(old.PPP.rate = case_when(Date < "2000-01-01 GMT" ~ oldPPPrate)) %>% 
  mutate(old.ERP.rate = case_when(Date < "2000-01-01 GMT" ~ oldERPrate))

plot <- ggplot(joint_sheet_310101, aes(x = Date, text = as_date(Date)))+
  geom_line(aes(y = (Net.Ove.Mig.Aus.Pre.12m + Nat.Inc.Aus.Pre.12m)/Est.Res.Pop.ERP.Aus, col = "Increase in ERP Annual Rate"), size = .8)+
  geom_line(aes(y = (net.movements.Pre.12m + Nat.Inc.Aus.Pre.12m)/Phy.Pre.Pop.PPP.Aus, col = "Increase in PPP Annual Rate"), size = .8)+
  geom_line(aes(y = mod.PPP.rate, col = "Average 2000-17 PPP growth rate"), size = 1, linetype = 4)+
  geom_line(aes(y = mod.ERP.rate, col = "Average 2000-17 ERP growth rate"), size = .8, linetype = 3)+
  geom_line(aes(y = old.PPP.rate, col = "Average 1982-99 PPP growth rate"), size = 1, linetype = 4)+
  geom_line(aes(y = old.ERP.rate, col = "Average 1982-99 ERP growth rate"), size = .8, linetype = 3)+
  scale_colour_manual("", 
                      breaks = c("Increase in PPP Annual Rate", "Increase in ERP Annual Rate", "Average 2000-2017 ERP growth rate", "Average 2000-2017 PPP growth rate", "Average 1982-1999 PPP growth rate", "Average 1982-1999 ERP growth rate"),
                      values = c("orange", "turquoise",  "orange3", "turquoise3", "red", "blue"))+
  labs(title = "Comparison of Alternative Population Growth Rates")+
  scale_y_continuous(labels = scales::percent, limits = c(0.0054, 0.025)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=70, t = 100, b = 70, r = 60),
         legend = list( x = 100))

```



```{r, fig.align="center", warning=FALSE, message= FALSE, fig.cap = "An assortment of alternative population measurements"}
Date <- c(as.POSIXct(as_date( "2011-09-09 GMT")))
Cen.Pop <- c( (10634012 + 10873706))
Census_2011 <- tibble(Date, Cen.Pop)

Date <- c(as.POSIXct(as_date("2016-09-09 GMT")))
Cen.Pop <- c(23401892)
Census_2016 <- tibble(Date, Cen.Pop)

plot<- ggplot(joint_sheet_310101, aes(x = Date, y = Est.Res.Pop.ERP.Aus, text = as_date(Date)))+
  #geom_vline(xintercept = as.numeric(sheet_340101$Date[date_change]), linetype = 4, size = 0.4) +
  geom_line(aes(y = Est.Res.Pop.ERP.Aus, col = "ERP"), size =0.8)+
  geom_line(aes(y = (Est.Res.Pop.ERP.Aus - cum.discrepancy), colour = "PPP"), linetype = 3, size = 1)+
  geom_point(data = Census_2011, aes(x = Date, y = Cen.Pop, colour = "Census 2011 PURP"),  shape = 4, size = 3)+ 
  geom_point(data = Census_2016, aes(x = Date, y = Cen.Pop, colour = "Census 2016 PURP"), shape = 4, size = 3)+
  scale_y_continuous(labels = scales::comma) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())+
  labs(title = "Estimated Resident Population (ERP), 
       Physically Present Population(PPP),
Recent Census Place of Ususal Residence (PURP) Counts")

ggplotly(plot, tooltip = c("text", "y")) %>% 
  layout(margin=list(l=100, t = 100, b = 100, r = 100),
         legend = list(y = 0.95, x = 0.1))


```

The .Rmd file for this post can be accessed which will require the installation of this [package](https://github.com/aidandmorrison/UtilsQQ) to run. 
